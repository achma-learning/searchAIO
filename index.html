<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Tools Search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="icon" type="image/svg+xml"
    href="https://upload.wikimedia.org/wikipedia/commons/a/a9/Vector_search_icon.svg" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Roboto:wght@400;500;700&family=Source+Code+Pro:wght@400;500;600&display=swap"
    rel="stylesheet">
  <style>
    .focus-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      z-index: 10;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .focus-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .dark-mode .focus-overlay {
      background: rgba(0, 0, 0, 0.6);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #000022 0%, #051937 50%, #001f3f 100%);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      margin: 0;
      padding: 20px 20px 52px; /* 52px bottom = space for legend bar */
    }

    .search-container {
      margin-top: 40px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      padding: 30px;
      max-width: 1200px;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 24px;
      position: relative;
      z-index: 20;
      transition: box-shadow 0.3s ease;
    }

    .search-container.focused {
      box-shadow: 0 12px 48px rgba(156, 90, 242, 0.2);
    }

    .dark-mode .search-container {
      background: #1a2332;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(100, 181, 246, 0.1);
    }

    .dark-mode .search-container.focused {
      box-shadow: 0 12px 48px rgba(156, 90, 242, 0.3);
    }

    .category-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
    }

    .category-section {
      background: linear-gradient(145deg, #f8f9fa, #e9ecef);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .category-section:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    }

    .category-title {
      font-weight: 900;
      color: #2c3e50;
      margin-bottom: 12px;
      font-size: 1.1em;
      border-bottom: 2px solid #667eea;
      padding-bottom: 8px;
      font-family: 'Papyrus', cursive, fantasy;
    }

    .radio-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .radio-group label {
      cursor: pointer;
      padding: 6px 10px;
      border-radius: 6px;
      transition: all 0.2s ease;
      font-size: 0.95em;
      display: flex;
      align-items: center;
      font-family: 'Papyrus', cursive, fantasy;
    }

    .radio-group input[type=radio] {
      accent-color: #9c5af2;
      cursor: pointer;
      margin-right: 8px;
      width: 16px;
      height: 16px;
      min-width: 16px;
      min-height: 16px;
      flex-shrink: 0;
      vertical-align: middle;
    }

    .dark-mode .radio-group input[type=radio] {
      accent-color: #9c5af2;
    }

    .radio-group label.selected,
    .radio-group label:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
      transform: translateX(4px);
    }

    .search-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      position: relative;
    }

    #searchForm {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      justify-content: center;
      flex-wrap: wrap;
    }

    #searchInput {
      padding: 12px 16px 12px 42px;
      font-size: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      min-width: 300px;
      width: 100%;
      background: #fafafa;
      transition: all 0.3s ease;
      font-family: 'Roboto', sans-serif;
      font-weight: 500;
    }

    #searchInput:focus {
      border-color: #9c5af2 !important;
      outline: none;
      background: white;
      box-shadow: 0 0 0 4px rgba(156, 90, 242, 0.4);
    }

    .dark-mode #searchInput:focus {
      border-color: #9c5af2 !important;
      background: rgba(255, 255, 255, 0.12);
      box-shadow: 0 0 0 4px rgba(156, 90, 242, 0.3);
    }

    button {
      padding: 12px 24px;
      font-size: 15px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 600;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    button:active {
      transform: translateY(0);
    }

    #searchForm button[type="submit"] {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    #wikiToggleBtn {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }

    #filetypesBtn {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
    }

    #duckBangBtn {
      background: linear-gradient(135deg, #DE5833 0%, #F7931E 100%);
      color: white;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      cursor: pointer;
      user-select: none;
    }

    .site-btn {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 600;
      border: 2px solid #ddd;
      border-radius: 20px;
      background: #f8f9fa;
      color: #555;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    .site-btn:hover {
      border-color: #4285f4;
      color: #4285f4;
      background: #e8f0fe;
    }
    .site-btn.active {
      background: #4285f4;
      border-color: #4285f4;
      color: #fff;
      box-shadow: 0 2px 8px rgba(66,133,244,0.4);
    }
    .site-btn-g-off {
      font-size: 13px;
      font-weight: 900;
      color: #aaa;
      font-family: 'Arial', sans-serif;
      line-height: 1;
    }
    .site-btn-g-on { display: none; }
    .site-btn.active .site-btn-g-off { display: none; }
    .site-btn.active .site-btn-g-on { display: inline-block; }
    .site-btn-logo {
      width: 14px;
      height: 14px;
      vertical-align: middle;
    }
    .dark-mode .site-btn {
      background: #2a3a4a;
      border-color: #4a5a6a;
      color: #aab;
    }
    .dark-mode .site-btn:hover {
      border-color: #64b5f6;
      color: #64b5f6;
      background: #1a3a5a;
    }
    .dark-mode .site-btn.active {
      background: #1565c0;
      border-color: #64b5f6;
      color: #fff;
    }
    .dark-mode .site-btn-g-off { color: #556; }

    #searchSource {
      font-size: 14px;
      color: #555;
      text-align: center;
      font-weight: 600;
      min-height: 20px;
      padding: 8px;
      border-radius: 6px;
      background: #f8f9fa;
      font-family: 'JetBrains Mono', 'Courier New', monospace;
    }

    #wikiContent {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 14px;
      padding: 0;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      font-size: 14px;
      color: #333;
      overflow: hidden;
      display: none;
    }

    .wiki-header {
      background: linear-gradient(135deg, #667eea11 0%, #764ba211 100%);
      border-bottom: 1px solid #e8e8f0;
      padding: 14px 16px 0;
    }
    .wiki-header-top {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .wiki-keep-open {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #888;
      white-space: nowrap;
    }
    .wiki-keep-open input { cursor: pointer; }
    .wiki-search-wrap {
      flex: 1;
      min-width: 160px;
      display: flex;
      align-items: center;
      background: white;
      border: 1.5px solid #d0d0e0;
      border-radius: 8px;
      padding: 4px 10px;
      gap: 6px;
      transition: border-color 0.2s;
    }
    .wiki-search-wrap:focus-within {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.12);
    }
    .wiki-search-icon { font-size: 12px; opacity: 0.5; }
    #wikiSearchInput {
      flex: 1;
      border: none;
      outline: none;
      font-size: 13px;
      background: transparent;
      color: #333;
    }
    #wikiSearchClear {
      border: none;
      background: none;
      cursor: pointer;
      font-size: 11px;
      color: #aaa;
      padding: 0;
      line-height: 1;
      display: none;
    }
    #wikiSearchClear:hover { color: #555; }

    .wiki-cat-tabs {
      display: flex;
      gap: 4px;
      overflow-x: auto;
      padding-bottom: 0;
      scrollbar-width: none;
    }
    .wiki-cat-tabs::-webkit-scrollbar { display: none; }
    .wiki-cat-tab {
      padding: 7px 14px;
      border: none;
      background: transparent;
      font-size: 12.5px;
      font-weight: 600;
      color: #888;
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      white-space: nowrap;
      transition: all 0.15s ease;
      border-bottom: 3px solid transparent;
      margin-bottom: -1px;
    }
    .wiki-cat-tab:hover { color: #667eea; background: rgba(102,126,234,0.06); }
    .wiki-cat-tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
      background: white;
    }

    .wiki-grid {
      padding: 16px;
      max-height: 340px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .wiki-section { display: block; }
    .wiki-section.hidden { display: none; }

    .wiki-section-title {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #667eea;
      margin-bottom: 8px;
    }

    .wiki-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .wiki-chip {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 5px 10px;
      border-radius: 20px;
      border: 1.5px solid #e0e0f0;
      background: #f8f8ff;
      cursor: pointer;
      transition: all 0.15s ease;
      font-size: 12.5px;
    }
    .wiki-chip:hover {
      border-color: #667eea;
      background: #eef0ff;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(102,126,234,0.2);
    }
    .wiki-chip.chip-highlight {
      border-color: #667eea;
      background: #667eea;
    }
    .wiki-chip.chip-highlight .wiki-chip-prefix,
    .wiki-chip.chip-highlight .wiki-chip-name { color: white; }
    .wiki-chip.chip-match-hidden { display: none; }

    .wiki-chip-prefix {
      font-family: 'JetBrains Mono','Courier New', monospace;
      font-weight: 700;
      font-size: 12px;
      color: #667eea;
    }
    .wiki-chip-name {
      color: #555;
      font-size: 12px;
    }

    .wiki-empty {
      text-align: center;
      padding: 24px;
      color: #aaa;
      font-size: 13px;
    }

    .wiki-hint {
      padding: 8px 16px;
      background: #f8f9ff;
      border-top: 1px solid #eee;
      font-size: 11.5px;
      color: #999;
    }

    .dark-mode #wikiContent { background: #1e2d3d; border-color: #2a3a4a; }
    .dark-mode .wiki-header { background: #1a2a3a; border-color: #2a3a4a; }
    .dark-mode .wiki-keep-open { color: #666; }
    .dark-mode .wiki-search-wrap { background: #2a3a4a; border-color: #3a4a5a; }
    .dark-mode #wikiSearchInput { color: #ddd; }
    .dark-mode .wiki-cat-tab { color: #666; }
    .dark-mode .wiki-cat-tab:hover { color: #64b5f6; background: rgba(100,181,246,0.06); }
    .dark-mode .wiki-cat-tab.active { color: #64b5f6; border-bottom-color: #64b5f6; background: #1e2d3d; }
    .dark-mode .wiki-section-title { color: #64b5f6; }
    .dark-mode .wiki-chip { background: #2a3a4a; border-color: #3a4a5a; }
    .dark-mode .wiki-chip:hover { border-color: #64b5f6; background: #1a3a5a; }
    .dark-mode .wiki-chip-prefix { color: #64b5f6; }
    .dark-mode .wiki-chip-name { color: #aab; }
    .dark-mode .wiki-hint { background: #1a2a3a; border-color: #2a3a4a; color: #666; }

    #wikiContent h4 {
      margin-top: 16px;
      margin-bottom: 8px;
      color: #667eea;
      font-size: 1.1em;
    }

    #wikiContent ul {
      margin: 0 0 16px 0;
      padding: 0;
      list-style: none;
    }

    #wikiContent li {
      margin-bottom: 8px;
      padding: 6px 10px;
      border-radius: 4px;
      transition: background 0.2s ease;
    }

    #wikiContent li:hover {
      background: #f0f0f0;
    }

    #wikiContent b {
      color: #667eea;
      font-weight: 700;
      font-family: 'Courier New', monospace;
      background: #f0f0ff;
      padding: 2px 6px;
      border-radius: 3px;
    }

    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e0e0e0;
    }

    #filetypesPopup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.96);
      width: 92%;
      max-width: 720px;
      max-height: 82vh;
      display: flex;
      flex-direction: column;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 24px 64px rgba(0,0,0,0.22), 0 4px 16px rgba(102,126,234,0.12);
      font-size: 14px;
      color: #333;
      z-index: 2000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.22s ease, transform 0.22s cubic-bezier(0.34,1.56,0.64,1);
      overflow: hidden;
    }

    #filetypesPopup.show {
      opacity: 1;
      pointer-events: auto;
      transform: translate(-50%, -50%) scale(1);
    }

    .ft-popup-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 22px 14px;
      border-bottom: 1px solid #eee;
      flex-shrink: 0;
      background: linear-gradient(135deg, #667eea08, #764ba208);
    }

    .ft-popup-header h3 {
      margin: 0;
      font-size: 1.2em;
      font-weight: 700;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .ft-popup-header p {
      margin: 4px 0 0;
      font-size: 12px;
      color: #888;
    }

    .ft-header-left { display: flex; flex-direction: column; }

    .ft-popup-header .close-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #f1f3f4;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
    }

    .ft-popup-header .close-btn:hover {
      background: #e53935;
      color: white;
      transform: rotate(90deg);
      box-shadow: none;
    }

    .ft-popup-body {
      overflow-y: auto;
      flex: 1;
      padding: 16px 22px;
    }

    .ft-popup-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 22px;
      border-top: 1px solid #eee;
      flex-shrink: 0;
      background: #fafbff;
      gap: 10px;
    }

    .ft-selected-count {
      font-size: 13px;
      color: #667eea;
      font-weight: 600;
      font-family: 'JetBrains Mono', monospace;
    }

    .ft-popup-footer-btns {
      display: flex;
      gap: 10px;
    }

    #clearFiletypes {
      background: #f1f3f4;
      color: #555;
      border: 1px solid #dadce0;
      font-size: 13px;
      padding: 9px 18px;
      border-radius: 8px;
    }

    #clearFiletypes:hover {
      background: #e8eaed;
    }

    #applyFiletypes {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 13px;
      padding: 9px 22px;
      border-radius: 8px;
    }

    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      z-index: 1999;
    }

    .popup-overlay.show {
      display: block;
    }

    #filetype-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(195px, 1fr));
      gap: 16px;
    }

    .filetype-category h4 {
      font-weight: 700;
      color: #667eea;
      margin-bottom: 10px;
      font-size: 1.1em;
      border-bottom: 1px solid #ddd;
      padding-bottom: 5px;
    }

    .dark-mode .filetype-category h4 {
      color: #64b5f6;
      border-bottom-color: #455a64;
    }

    .filetype-item label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 5px;
      border-radius: 4px;
    }

    .filetype-item label:hover {
      background-color: #f0f2f5;
    }

    .dark-mode .filetype-item label:hover {
      background-color: #2c3e50;
    }

    .favicon-icon {
      width: 16px;
      height: 16px;
      margin-right: 8px;
      vertical-align: middle;
      border-radius: 2px;
    }

    #search-prefix-favicon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 22px;
      height: 22px;
      border-radius: 50%;
      object-fit: cover;
      z-index: 2;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }

    @keyframes faviconSwap {
      0%   { opacity: 0; transform: translateY(-50%) scale(0.6); }
      100% { opacity: 1; transform: translateY(-50%) scale(1); }
    }

    #search-prefix-favicon.swapping {
      animation: faviconSwap 0.2s ease-out forwards;
    }

    @media (max-width: 768px) {
      .search-container {
        padding: 20px;
        margin-top: 20px;
      }

      .category-row {
        grid-template-columns: 1fr;
      }

      #searchInput {
        min-width: 100%;
      }

      #searchForm {
        flex-direction: column;
        width: 100%;
      }

      #searchForm button {
        width: 100%;
      }

      #filetypesPopup {
        width: 95%;
        max-height: 70vh;
      }
    }

    .ft-popup-body::-webkit-scrollbar { width: 6px; }
    .ft-popup-body::-webkit-scrollbar-track { background: transparent; }
    .ft-popup-body::-webkit-scrollbar-thumb { background: rgba(102,126,234,0.35); border-radius: 8px; }
    .ft-popup-body::-webkit-scrollbar-thumb:hover { background: rgba(102,126,234,0.6); }

    .filetype-item input[type=checkbox] {
      accent-color: #667eea;
      width: 15px;
      height: 15px;
      flex-shrink: 0;
    }

    .filetype-item label:has(input:checked) {
      background: linear-gradient(135deg, #667eea12, #764ba212);
      color: #4a3fa0;
      font-weight: 600;
    }

    .dark-mode .filetype-item label:has(input:checked) {
      background: rgba(100,181,246,0.1);
      color: #90caf9;
    }

    #wikiContent::-webkit-scrollbar,
    #filetypesPopup::-webkit-scrollbar {
      width: 8px;
    }

    #wikiContent::-webkit-scrollbar-track,
    #filetypesPopup::-webkit-scrollbar-track {
      background: #f0f0f0;
      border-radius: 4px;
    }

    #wikiContent::-webkit-scrollbar-thumb,
    #filetypesPopup::-webkit-scrollbar-thumb {
      background: #667eea;
      border-radius: 4px;
    }

    #stars-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      overflow: hidden;
    }

    #stars,
    #stars2,
    #stars3 {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-repeat: repeat;
      background-position: 0 0;
      animation-timing-function: linear;
      animation-iteration-count: infinite;
    }

    #stars {
      background-image: radial-gradient(1px 1px at 20px 30px, #eee, rgba(0, 0, 0, 0)),
        radial-gradient(1px 1px at 40px 70px, #fff, rgba(0, 0, 0, 0)),
        radial-gradient(1px 1px at 90px 40px, #fff, rgba(0, 0, 0, 0)),
        radial-gradient(2px 2px at 130px 80px, #fff, rgba(0, 0, 0, 0)),
        radial-gradient(2px 2px at 160px 120px, #ddd, rgba(0, 0, 0, 0));
      background-size: 200px 200px;
      animation-name: move-stars, twinkle;
      animation-duration: 15s, 5s;
    }

    #stars2 {
      background-image: radial-gradient(1px 1px at 50px 100px, #fff, rgba(0, 0, 0, 0)),
        radial-gradient(1px 1px at 120px 40px, #ddd, rgba(0, 0, 0, 0)),
        radial-gradient(2px 2px at 50px 150px, #fff, rgba(0, 0, 0, 0)),
        radial-gradient(2px 2px at 100px 200px, #ddd, rgba(0, 0, 0, 0));
      background-size: 300px 300px;
      animation-name: move-stars, twinkle;
      animation-duration: 30s, 7s;
    }

    #stars3 {
      background-image: radial-gradient(1px 1px at 80px 50px, #fff, rgba(0, 0, 0, 0)),
        radial-gradient(2px 2px at 150px 100px, #ddd, rgba(0, 0, 0, 0));
      background-size: 400px 400px;
      animation-name: move-stars, twinkle;
      animation-duration: 45s, 10s;
    }

    @keyframes twinkle {
      0% { opacity: 0; }
      50% { opacity: 0.7; }
      100% { opacity: 0; }
    }

    @keyframes move-stars {
      from { transform: translateY(0px); }
      to { transform: translateY(-200px); }
    }

    .dark-mode {
      background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
      color: #b0bec5;
    }

    .dark-mode .search-container {
      background: #1a2332;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(100, 181, 246, 0.1);
    }

    .dark-mode .category-section {
      background: #243447;
      border: 1px solid #2d3e52;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .dark-mode .category-section:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      border-color: #64b5f6;
    }

    .dark-mode .category-title {
      color: #64b5f6;
      border-bottom-color: #64b5f6;
    }

    .dark-mode .radio-group label {
      color: #b0bec5;
    }

    .dark-mode .radio-group label:hover,
    .dark-mode .radio-group label.selected {
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      color: #ffffff;
    }

    .dark-mode #searchInput {
      background: rgba(255, 255, 255, 0.08);
      border: 2px solid #2d3e52;
      color: #b0bec5;
    }

    .dark-mode #searchInput:focus {
      border-color: #64b5f6;
      background: rgba(255, 255, 255, 0.12);
    }

    .dark-mode #searchSource {
      background: #243447;
      color: #b0bec5;
    }

    #googleOperatorFilters .category-title,
    #bingOperatorFilters .category-title,
    #youtubeFilters .category-title,
    #cismefFilters .category-title,
    #ammpsFilters .category-title {
      font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      font-weight: 700;
    }

    .dark-mode #filetypesPopup {
      background: #1a2332;
      color: #b0bec5;
      box-shadow: 0 24px 64px rgba(0,0,0,0.5), 0 4px 16px rgba(100,181,246,0.1);
    }

    .dark-mode .ft-popup-header {
      border-bottom-color: #2d3e52;
      background: rgba(100,181,246,0.04);
    }

    .dark-mode .ft-popup-header h3 {
      color: #64b5f6;
    }

    .dark-mode .ft-popup-header p {
      color: #78909c;
    }

    .dark-mode .ft-popup-header .close-btn {
      background: #243447;
      color: #b0bec5;
    }

    .dark-mode .ft-popup-footer {
      border-top-color: #2d3e52;
      background: #1e2e40;
    }

    .dark-mode .ft-popup-body::-webkit-scrollbar-track { background: #1a2332; }
    .dark-mode .ft-popup-body::-webkit-scrollbar-thumb { background: rgba(100,181,246,0.3); }

    .dark-mode #clearFiletypes {
      background-color: #303134;
      color: #e8eaed;
      border-color: #5f6368;
    }

    .dark-mode #clearFiletypes:hover { background-color: #3c4043; }

    .dark-mode #searchForm button[type="submit"] {
      background: linear-gradient(135deg, #4285f4, #34a853);
      box-shadow: 0 4px 12px rgba(66, 133, 244, 0.4);
    }

    .dark-mode #wikiToggleBtn {
      background: linear-gradient(135deg, #cb6d51, #d6845e);
    }

    .dark-mode #filetypesBtn {
      background: linear-gradient(135deg, #4caf50, #45a049);
    }

    .dark-mode #darkModeToggleBtn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .dark-mode button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
    }

    #youtubeFilters {
      display: none;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
      border: 2px solid #667eea;
      box-shadow: 0 4px 24px rgba(102, 126, 234, 0.25);
      padding: 10px;
      border-radius: 12px;
    }

    .dark-mode #youtubeFilters {
      border-color: #64b5f6;
      box-shadow: 0 4px 24px rgba(100, 181, 246, 0.25);
    }

    #googleOperatorFilters {
      display: none;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
      border: 2px solid #4285F4;
      box-shadow: 0 4px 24px rgba(66, 133, 244, 0.25);
      padding: 10px;
      border-radius: 12px;
    }

    .dark-mode #googleOperatorFilters {
      border-color: #64b5f6;
      box-shadow: 0 4px 24px rgba(100, 181, 246, 0.25);
    }

    #bingOperatorFilters {
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
    }

    #cismefFilters {
      display: none;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
      border: 2px solid #005689;
      box-shadow: 0 4px 24px rgba(0, 86, 137, 0.25);
      padding: 10px;
      border-radius: 12px;
    }

    .dark-mode #cismefFilters {
      border-color: #64b5f6;
      box-shadow: 0 4px 24px rgba(100, 181, 246, 0.25);
    }

    #ammpsFilters {
      display: none;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
      border: 2px solid #2e7d32;
      box-shadow: 0 4px 24px rgba(46, 125, 50, 0.25);
      padding: 10px;
      border-radius: 12px;
    }

    .dark-mode #ammpsFilters {
      border-color: #66bb6a;
      box-shadow: 0 4px 24px rgba(102, 187, 106, 0.25);
    }

    .operators-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .operator-btn {
      background-color: #f1f3f4;
      border: 1px solid #dadce0;
      border-radius: 4px;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .operator-btn:hover {
      background-color: #e8eaed;
    }

    .dark-mode .operator-btn {
      background-color: #303134;
      border-color: #5f6368;
      color: #e8eaed;
    }

    .dark-mode .operator-btn:hover {
      background-color: #3c4043;
    }

    #googleWikiPopup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 700px;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      padding: 24px;
      font-size: 14px;
      color: #333;
      display: none;
      z-index: 2000;
    }

    #googleWikiPopup.show {
      display: block;
    }

    .dark-mode #googleWikiPopup {
      background: #1a2332;
      border-color: #2d3e52;
      color: #b0bec5;
    }

    #googleWikiPopup .close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 28px;
      cursor: pointer;
      color: #999;
      background: none;
      border: none;
      padding: 0;
    }

    #googleWikiPopup .close-btn:hover {
      color: #333;
    }

    .dark-mode #googleWikiPopup .close-btn:hover {
      color: #fff;
    }

    #bingWikiPopup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 700px;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      padding: 24px;
      font-size: 14px;
      color: #333;
      display: none;
      z-index: 2000;
    }

    #bingWikiPopup.show {
      display: block;
    }

    .dark-mode #bingWikiPopup {
      background: #1a2332;
      border-color: #2d3e52;
      color: #b0bec5;
    }

    #bingWikiPopup .close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 28px;
      cursor: pointer;
      color: #999;
      background: none;
      border: none;
      padding: 0;
    }

    #bingWikiPopup .close-btn:hover {
      color: #333;
    }

    .dark-mode #bingWikiPopup .close-btn:hover {
      color: #fff;
    }

    #bingWikiPopup h3 {
      margin-top: 0;
      color: #2c3e50;
      border-bottom: 3px solid #667eea;
      padding-bottom: 10px;
    }

    .dark-mode #bingWikiPopup h3 {
      color: #64b5f6;
      border-bottom-color: #64b5f6;
    }

    #keyboardShortcutsPopup {
      position: fixed !important;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 92%;
      max-width: 780px;
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 10px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.7), 0 0 0 1px rgba(99,179,237,0.08);
      padding: 0;
      z-index: 2005;
      overflow: hidden;
      font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
      display: none;
    }

    #keyboardShortcutsPopup.show {
      display: block !important;
    }

    .cheat-section-wide {
      grid-column: 1 / -1;
    }

    .cheat-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: #161b22;
      border-bottom: 1px solid #30363d;
    }
    .cheat-dot {
      width: 12px; height: 12px;
      border-radius: 50%;
    }
    .cheat-dot.red    { background: #ff5f57; }
    .cheat-dot.yellow { background: #ffbd2e; }
    .cheat-dot.green  { background: #28c941; }
    .cheat-title {
      flex: 1;
      text-align: center;
      font-size: 12px;
      color: #8b949e;
      letter-spacing: 0.08em;
      margin-right: 36px;
    }
    .cheat-title span { color: #58a6ff; }

    .cheat-body {
      padding: 20px;
      max-height: 72vh;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #30363d #0d1117;
    }
    .cheat-body::-webkit-scrollbar { width: 6px; }
    .cheat-body::-webkit-scrollbar-track { background: #0d1117; }
    .cheat-body::-webkit-scrollbar-thumb { background: #30363d; border-radius: 3px; }

    .cheat-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    @media (max-width: 580px) { .cheat-grid { grid-template-columns: 1fr; } }

    .cheat-section {
      background: #161b22;
      border: 1px solid #21262d;
      border-radius: 6px;
      overflow: hidden;
    }
    .cheat-section-title {
      padding: 7px 12px;
      background: #1c2128;
      border-bottom: 1px solid #21262d;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #58a6ff;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .cheat-section-title::before {
      content: '#';
      color: #3fb950;
    }
    .cheat-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 7px 12px;
      border-bottom: 1px solid #21262d1a;
      gap: 12px;
      transition: background 0.1s;
    }
    .cheat-row:last-child { border-bottom: none; }
    .cheat-row:hover { background: #21262d; }

    .cheat-keys {
      display: flex;
      align-items: center;
      gap: 3px;
      flex-shrink: 0;
    }
    .kbd {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 7px;
      background: #21262d;
      border: 1px solid #444c56;
      border-bottom: 2px solid #444c56;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      color: #e6edf3;
      white-space: nowrap;
      font-family: inherit;
    }
    .kbd-sep {
      color: #484f58;
      font-size: 11px;
      padding: 0 1px;
    }
    .cheat-desc {
      font-size: 11.5px;
      color: #8b949e;
      text-align: right;
      line-height: 1.4;
    }
    .cheat-desc .hl { color: #e6edf3; }
    .cheat-desc .hl-green { color: #3fb950; }
    .cheat-desc .hl-blue { color: #79c0ff; }
    .cheat-desc .hl-orange { color: #d29922; }

    .cheat-footer {
      padding: 8px 16px;
      background: #161b22;
      border-top: 1px solid #30363d;
      font-size: 10.5px;
      color: #484f58;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .cheat-esc {
      display: inline-block;
      padding: 1px 6px;
      background: #21262d;
      border: 1px solid #444c56;
      border-bottom: 2px solid #444c56;
      border-radius: 3px;
      font-size: 10px;
      color: #8b949e;
      font-family: inherit;
    }
    #cheat-shortcut-count, .cheat-count {
      color: #3fb950;
      font-size: 10px;
    }

    #googleWikiPopup h3 {
      margin-top: 0;
      color: #2c3e50;
      border-bottom: 3px solid #667eea;
      padding-bottom: 10px;
    }

    .dark-mode #googleWikiPopup h3 {
      color: #64b5f6;
      border-bottom-color: #64b5f6;
    }

    .wiki-table {
      width: 100%;
      border-collapse: collapse;
      margin: 16px 0;
    }

    .wiki-table th,
    .wiki-table td {
      border: 1px solid #ddd;
      padding: 8px 10px;
      text-align: left;
    }

    .wiki-table th {
      background-color: #f2f2f2;
    }

    .wiki-table code {
      background: #f0f0ff;
      padding: 2px 5px;
      border-radius: 4px;
      color: #667eea;
      font-weight: 600;
    }

    .dark-mode .wiki-table,
    .dark-mode .wiki-table th,
    .dark-mode .wiki-table td {
      border-color: #455a64;
    }

    .dark-mode .wiki-table th {
      background-color: #243447;
    }

    .dark-mode .wiki-table code {
      background: #243447;
      color: #82aaff;
    }

    .dark-mode #googleWikiPopup a {
      color: #82aaff;
    }

    .operator-tooltip {
      position: fixed;
      background: #fff;
      color: #202124;
      padding: 12px 14px 10px;
      border-radius: 10px;
      font-size: 13px;
      z-index: 10000;
      pointer-events: none;
      display: none;
      opacity: 0;
      transition: opacity 0.18s ease;
      max-width: 240px;
      min-width: 190px;
      box-shadow: 0 4px 18px rgba(0,0,0,0.18), 0 1px 4px rgba(0,0,0,0.1);
      border: 1px solid #e8eaed;
      text-align: left;
      line-height: 1.45;
    }
    .op-tip-desc {
      font-size: 13px;
      color: #202124;
      font-weight: 500;
      margin-bottom: 6px;
      display: block;
    }
    .op-tip-example {
      font-size: 11.5px;
      color: #70757a;
      display: block;
      font-family: 'JetBrains Mono', 'Courier New', monospace;
      margin-bottom: 8px;
    }
    .op-tip-footer {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      border-top: 1px solid #f1f3f4;
      padding-top: 6px;
      margin-top: 2px;
    }
    .op-tip-footer img {
      width: 16px;
      height: 16px;
    }

    .dark-mode .operator-tooltip {
      background: #2d2d2d;
      color: #e8eaed;
      border-color: #444;
      box-shadow: 0 4px 18px rgba(0,0,0,0.5);
    }
    .dark-mode .op-tip-desc { color: #e8eaed; }
    .dark-mode .op-tip-example { color: #9aa0a6; }
    .dark-mode .op-tip-footer { border-color: #444; }

    .autocomplete-container {
      position: relative;
      flex: 1;
      max-width: 500px;
      min-width: 300px;
    }

    #autocomplete {
      position: fixed;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 20px;
      box-shadow:
        0 8px 32px rgba(0, 0, 0, 0.12),
        0 2px 8px rgba(0, 0, 0, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
      max-height: 400px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      padding: 20px;
      width: calc(100% - 40px);
      max-width: 1160px;
      animation: floatIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      transform-origin: top center;
    }

    @keyframes floatIn {
      from { opacity: 0; transform: translateY(-10px) scale(0.95); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }

    .dark-mode #autocomplete {
      background: rgba(26, 35, 50, 0.85);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid rgba(100, 181, 246, 0.2);
      box-shadow:
        0 8px 32px rgba(0, 0, 0, 0.4),
        0 2px 8px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(100, 181, 246, 0.1);
    }

    #autocomplete::-webkit-scrollbar { width: 8px; }
    #autocomplete::-webkit-scrollbar-track { background: transparent; }
    #autocomplete::-webkit-scrollbar-thumb { background: rgba(156, 90, 242, 0.3); border-radius: 10px; }
    #autocomplete::-webkit-scrollbar-thumb:hover { background: rgba(156, 90, 242, 0.5); }
    .dark-mode #autocomplete::-webkit-scrollbar-thumb { background: rgba(100, 181, 246, 0.3); }
    .dark-mode #autocomplete::-webkit-scrollbar-thumb:hover { background: rgba(100, 181, 246, 0.5); }

    .autocomplete-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
    }

    .autocomplete-column {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .autocomplete-column-title {
      font-weight: 900;
      color: #2c3e50;
      margin-bottom: 8px;
      font-size: 0.95em;
      border-bottom: 2px solid #667eea;
      padding-bottom: 6px;
      font-family: 'Papyrus', cursive, fantasy;
    }

    .dark-mode .autocomplete-column-title {
      color: #64b5f6;
      border-bottom-color: #64b5f6;
    }

    .autocomplete-item {
      padding: 8px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      border-radius: 6px;
      transition: all 0.2s;
      font-size: 0.9em;
    }

    .autocomplete-item:hover,
    .autocomplete-item.selected {
      background: linear-gradient(135deg, #667eea15, #764ba215);
      transform: translateX(4px);
    }

    .dark-mode .autocomplete-item:hover,
    .dark-mode .autocomplete-item.selected {
      background: #243447;
    }

    .autocomplete-item .favicon-icon {
      flex-shrink: 0;
    }

    .autocomplete-prefix {
      font-family: 'Courier New', monospace;
      font-weight: 700;
      color: #667eea;
      min-width: 60px;
      font-size: 0.85em;
    }

    .dark-mode .autocomplete-prefix {
      color: #64b5f6;
    }

    .autocomplete-name {
      color: #555;
      flex: 1;
      font-size: 0.9em;
    }

    .dark-mode .autocomplete-name {
      color: #b0bec5;
    }

    @media (max-width: 1024px) {
      #autocomplete { min-width: 600px; }
      .autocomplete-grid { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 600px) {
      #autocomplete { min-width: 90vw; }
      .autocomplete-grid { grid-template-columns: 1fr; }
    }

    /* ============================================ */
    /* !BANG INDICATOR PILL                         */
    /* ============================================ */

    #bang-indicator {
      display: none;
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      font-size: 12px;
      font-family: 'JetBrains Mono', 'Source Code Pro', monospace;
      padding: 4px 10px 4px 8px;
      border-radius: 20px;
      white-space: nowrap;
      pointer-events: none;
      z-index: 200;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.45);
      animation: bang-pop 0.15s ease;
      gap: 5px;
      align-items: center;
    }
    #bang-indicator.visible { display: flex; }
    #bang-indicator .bang-arrow { opacity: 0.75; margin: 0 3px; }
    #bang-indicator .bang-engine { font-weight: 700; }
    #bang-indicator .bang-hint { opacity: 0.8; font-size: 10px; margin-left: 6px; font-family: inherit; }
    @keyframes bang-pop {
      from { opacity: 0; transform: translateY(-4px) scale(0.95); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }
    .dark-mode #bang-indicator {
      box-shadow: 0 2px 8px rgba(100, 181, 246, 0.35);
    }

    /* ============================================ */
    /* LANGUAGE TRANSLATION                         */
    /* ============================================ */

    .lang-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      color: white;
      font-size: 20px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(66, 133, 244, 0.3);
      user-select: none;
      border: none;
    }

    .lang-icon:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 4px 16px rgba(66, 133, 244, 0.5);
      background: linear-gradient(135deg, #3367d6 0%, #2d8f46 100%);
    }

    .lang-icon.language-selected {
      background: white;
      color: #4285f4;
      border: 2px solid #4285f4;
      font-weight: 700;
      font-size: 13px;
      font-family: 'Courier New', monospace;
      box-shadow: 0 2px 8px rgba(66, 133, 244, 0.4);
    }

    .lang-icon.language-selected:hover {
      background: #f8f9fa;
      border-color: #3367d6;
      color: #3367d6;
    }

    .dark-mode .lang-icon {
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      box-shadow: 0 2px 8px rgba(30, 60, 114, 0.5);
    }

    .dark-mode .lang-icon:hover {
      background: linear-gradient(135deg, #2a5298, #3a6bb8);
    }

    .dark-mode .lang-icon.language-selected {
      background: #1a2332;
      color: #64b5f6;
      border-color: #64b5f6;
    }

    #langPopup {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      padding: 20px;
      overflow: auto;
    }

    #langPopup.show {
      display: flex !important;
    }

    #langPopupContent {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
      padding: 30px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow: auto;
      position: relative;
      animation: popupSlideIn 0.3s ease;
    }

    .dark-mode #langPopupContent {
      background: #1a2332;
      border: 2px solid #2d3e52;
    }

    #langPopupContent .close-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 32px;
      height: 32px;
      border: none;
      background: #dc3545;
      color: white;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
      padding: 0;
      transition: all 0.2s ease;
    }

    #langPopupContent .close-btn:hover {
      background: #c82333;
      transform: rotate(90deg);
      box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4);
    }

    #langPopupContent h2 {
      margin: 0 40px 20px 0;
      color: #333;
      font-size: 22px;
      padding-right: 40px;
    }

    .dark-mode #langPopupContent h2 {
      color: #64b5f6;
    }

    .lang-search-container {
      margin-bottom: 20px;
    }

    #langSearchInput {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 15px;
      box-sizing: border-box;
      outline: none;
      transition: all 0.2s ease;
    }

    #langSearchInput:focus {
      border-color: #4285f4;
      box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    }

    .dark-mode #langSearchInput {
      background: #243447;
      border-color: #2d3e52;
      color: #b0bec5;
    }

    .dark-mode #langSearchInput:focus {
      border-color: #64b5f6;
      box-shadow: 0 0 0 3px rgba(100, 181, 246, 0.1);
    }

    #langSuggestions {
      margin-top: 8px;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      display: none;
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .dark-mode #langSuggestions {
      background: #243447;
      border-color: #2d3e52;
    }

    .lang-suggestion {
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s ease;
    }

    .lang-suggestion:hover {
      background: #f0f4ff;
    }

    .lang-suggestion:last-child {
      border-bottom: none;
    }

    .dark-mode .lang-suggestion {
      border-bottom-color: #2d3e52;
    }

    .dark-mode .lang-suggestion:hover {
      background: #2c3e50;
    }

    .lang-suggestion strong { color: #333; font-weight: 600; }
    .lang-suggestion span  { color: #888; font-size: 12px; }
    .dark-mode .lang-suggestion strong { color: #b0bec5; }
    .dark-mode .lang-suggestion span   { color: #78909c; }

    .lang-buttons-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .lang-btn {
      padding: 14px;
      background: #4285f4;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      position: relative;
      box-shadow: 0 2px 4px rgba(66, 133, 244, 0.3);
    }

    .lang-btn:hover {
      background: #3367d6;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(66, 133, 244, 0.4);
    }

    .lang-btn:active { transform: translateY(0); }

    .lang-btn[data-lang="original"] {
      grid-column: 1 / -1;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-size: 15px;
      padding: 16px;
    }

    .lang-btn[data-lang="original"]:hover {
      background: linear-gradient(135deg, #5568d3 0%, #653a8c 100%);
    }

    .dark-mode .lang-btn {
      background: #1e3c72;
      box-shadow: 0 2px 4px rgba(30, 60, 114, 0.5);
    }

    .dark-mode .lang-btn:hover {
      background: #2a5298;
      box-shadow: 0 4px 12px rgba(42, 82, 152, 0.5);
    }

    .dark-mode .lang-btn[data-lang="original"] {
      background: linear-gradient(135deg, #1e3c72, #2a5298);
    }

    .lang-btn::after {
      content: attr(title);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-5px);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 10;
    }

    .lang-btn:hover::after {
      opacity: 1;
      transform: translateX(-50%) translateY(-8px);
    }

    .lang-btn[data-lang="original"]::after { display: none; }

    .dark-mode .lang-btn::after {
      background: rgba(255, 255, 255, 0.95);
      color: #1a2332;
    }

    .lang-info {
      text-align: center;
      margin: 0;
      color: #666;
      font-size: 12px;
    }

    .dark-mode .lang-info { color: #b0bec5; }

    .lang-info kbd {
      display: inline-block;
      padding: 2px 6px;
      background: #f4f4f4;
      border: 1px solid #ccc;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .dark-mode .lang-info kbd {
      background: #243447;
      border-color: #455a64;
      color: #b0bec5;
    }

    @keyframes popupSlideIn {
      from { opacity: 0; transform: scale(0.9); }
      to   { opacity: 1; transform: scale(1); }
    }

    @media (max-width: 768px) {
      .lang-buttons-grid { grid-template-columns: repeat(2, 1fr); }
      #langPopupContent { padding: 24px; max-width: 95%; }
      .lang-icon { width: 36px; height: 36px; font-size: 18px; }
    }

    @media (max-width: 480px) {
      .lang-buttons-grid { grid-template-columns: 1fr; }
      .lang-btn[data-lang="original"] { grid-column: 1; }
    }

    .notification {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(33, 33, 33, 0.9);
      color: white;
      padding: 12px 24px;
      border-radius: 50px;
      font-size: 14px;
      z-index: 10000;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .notification.show {
      opacity: 1;
      transform: translateX(-50%) translateY(-10px);
    }

    .notification.success { border-left: 4px solid #4CAF50; }
    .notification.error   { border-left: 4px solid #F44336; }
    .notification.info    { border-left: 4px solid #2196F3; }

    /* ── Paste-required legend bar ─────────────────────────── */
    #paste-legend {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(25, 35, 50, 0.92);
      color: #b0bec5;
      font-size: 12px;
      text-align: center;
      padding: 6px 16px;
      z-index: 9000;
      backdrop-filter: blur(6px);
      border-top: 1px solid rgba(100, 181, 246, 0.18);
      letter-spacing: 0.01em;
      pointer-events: none;
      user-select: none;
    }
    #paste-legend kbd {
      display: inline-block;
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.25);
      border-radius: 4px;
      padding: 1px 6px;
      font-family: 'JetBrains Mono', 'Source Code Pro', monospace;
      font-size: 11px;
      color: #e0e0e0;
      margin: 0 2px;
    }
    .dark-mode #paste-legend {
      background: rgba(10, 18, 28, 0.95);
      border-top-color: rgba(100, 181, 246, 0.22);
    }

    /* ============================================ */
    /* ============================================ */
    /* YANDEX TRANSLATION BOX                       */
    /* ============================================ */

    #yandexTranslationBox {
      display: none;
      margin-bottom: 0;
    }

    #yandexTranslationBox .category-title {
      border-bottom-color: #ff0000;
    }

    .yandex-hint {
      font-size: 12px;
      color: #888;
      font-style: italic;
      margin-bottom: 10px;
      padding: 6px 10px;
      background: rgba(255, 0, 0, 0.05);
      border-left: 3px solid #ff0000;
      border-radius: 0 4px 4px 0;
      line-height: 1.5;
    }

    .yandex-controls-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    #yandexSourceLang {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #ddd;
      background: white;
      color: #333;
      font-size: 13px;
      cursor: pointer;
      flex-shrink: 0;
      min-width: 150px;
      transition: border-color 0.2s;
    }

    #yandexSourceLang:focus {
      outline: none;
      border-color: #ff0000;
      box-shadow: 0 0 0 3px rgba(255, 0, 0, 0.1);
    }

    #yandexSourceText {
      flex: 1;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ddd;
      font-size: 13px;
      background: white;
      color: #333;
      transition: border-color 0.2s;
      min-width: 200px;
    }

    #yandexSourceText:focus {
      outline: none;
      border-color: #ff0000;
      box-shadow: 0 0 0 3px rgba(255, 0, 0, 0.1);
    }

    #yandexSourceText::placeholder { color: #aaa; font-style: italic; }

    #yandexTargetText {
      width: 100%;
      min-height: 70px;
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid #ddd;
      font-size: 13px;
      background: #fafafa;
      color: #333;
      resize: vertical;
      margin-bottom: 10px;
      box-sizing: border-box;
      transition: border-color 0.2s;
    }

    #yandexTargetText:focus {
      outline: none;
      border-color: #ff0000;
    }

    .yandex-buttons-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    #yandexOpenBtn {
      background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 7px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    #yandexOpenBtn:hover {
      background: linear-gradient(135deg, #dd0000 0%, #aa0000 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255, 0, 0, 0.4);
    }

    #yandexOpenBtn:active { transform: translateY(0); }

    #yandexTranslateSearchBtn,
    #baiduTranslateSearchBtn {
      background: linear-gradient(135deg, #00897b 0%, #00695c 100%);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 7px 13px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 5px;
      white-space: nowrap;
    }
    #yandexTranslateSearchBtn:hover,
    #baiduTranslateSearchBtn:hover {
      background: linear-gradient(135deg, #00796b 0%, #004d40 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 137, 123, 0.45);
    }
    #yandexTranslateSearchBtn:active,
    #baiduTranslateSearchBtn:active { transform: translateY(0); }
    .dark-mode #yandexTranslateSearchBtn,
    .dark-mode #baiduTranslateSearchBtn {
      background: linear-gradient(135deg, #26a69a 0%, #00897b 100%);
    }

    #yandexTranslateStatus {
      font-size: 12px;
      min-height: 18px;
      margin-top: 8px;
      padding-left: 2px;
      transition: color 0.2s;
    }

    #yandexTranslateStatus.loading { color: #ff9800; }
    #yandexTranslateStatus.success { color: #4caf50; }
    #yandexTranslateStatus.error   { color: #f44336; }

    /* Dark mode — Yandex */
    .dark-mode #yandexTranslationBox .category-title {
      color: #ef9a9a;
      border-bottom-color: #ef9a9a;
    }

    .dark-mode .yandex-hint {
      background: rgba(239, 154, 154, 0.08);
      border-left-color: #ef9a9a;
      color: #90a4ae;
    }

    .dark-mode #yandexSourceLang {
      background: #1a2332;
      border-color: #2d3e52;
      color: #b0bec5;
    }

    .dark-mode #yandexSourceLang:focus {
      border-color: #ef9a9a;
      box-shadow: 0 0 0 3px rgba(239, 154, 154, 0.15);
    }

    .dark-mode #yandexSourceText {
      background: #1a2332;
      border-color: #2d3e52;
      color: #b0bec5;
    }

    .dark-mode #yandexSourceText:focus {
      border-color: #ef9a9a;
      box-shadow: 0 0 0 3px rgba(239, 154, 154, 0.15);
    }

    .dark-mode #yandexSourceText::placeholder { color: #546e7a; }

    .dark-mode #yandexTargetText {
      background: #0f1924;
      border-color: #2d3e52;
      color: #b0bec5;
    }

    .dark-mode #yandexOpenBtn {
      background: linear-gradient(135deg, #8b0000 0%, #5d0000 100%);
      box-shadow: 0 2px 8px rgba(139, 0, 0, 0.4);
    }

    .dark-mode #yandexOpenBtn:hover {
      background: linear-gradient(135deg, #a00000 0%, #6e0000 100%);
      box-shadow: 0 4px 14px rgba(160, 0, 0, 0.5);
    }

    .dark-mode #yandexTranslateStatus { color: #78909c; }

    /* BAIDU FANYI TRANSLATION BOX                  */
    /* ============================================ */

    #baiduTranslationBox {
      display: none;
      margin-bottom: 0;
    }

    /* Reuse the grid display from youtubeFilters for layout consistency */
    #baiduTranslationBox .category-section {
      /* inherits base .category-section styles */
    }

    #baiduTranslationBox .category-title {
      /* inherits base; override border colour to Baidu red */
      border-bottom-color: #cc0000;
    }

    .baidu-hint {
      font-size: 12px;
      color: #888;
      font-style: italic;
      margin-bottom: 10px;
      padding: 6px 10px;
      background: rgba(204, 0, 0, 0.05);
      border-left: 3px solid #cc0000;
      border-radius: 0 4px 4px 0;
      line-height: 1.5;
    }

    .baidu-controls-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    #baiduSourceLang {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #ddd;
      background: white;
      color: #333;
      font-size: 13px;
      cursor: pointer;
      flex-shrink: 0;
      min-width: 180px;
      transition: border-color 0.2s;
    }

    #baiduSourceLang:focus {
      outline: none;
      border-color: #cc0000;
      box-shadow: 0 0 0 3px rgba(204, 0, 0, 0.1);
    }

    #baiduSourceText {
      flex: 1;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ddd;
      font-size: 13px;
      background: white;
      color: #333;
      transition: border-color 0.2s;
      min-width: 200px;
    }

    #baiduSourceText:focus {
      outline: none;
      border-color: #cc0000;
      box-shadow: 0 0 0 3px rgba(204, 0, 0, 0.1);
    }

    #baiduSourceText::placeholder {
      color: #aaa;
      font-style: italic;
    }

    .baidu-buttons-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    #baiduOpenBtn {
      background: linear-gradient(135deg, #cc0000 0%, #990000 100%);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 7px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    #baiduOpenBtn:hover {
      background: linear-gradient(135deg, #aa0000 0%, #770000 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(204, 0, 0, 0.4);
    }

    #baiduCopyBtn,
    #baiduInsertBtn {
      /* inherits .operator-btn */
    }

    #baiduTargetText {
      width: 100%;
      min-height: 68px;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
      resize: vertical;
      background: #f8f9fa;
      color: #333;
      box-sizing: border-box;
      margin-top: 6px;
      transition: border-color 0.2s;
    }
    #baiduTargetText:focus {
      outline: none;
      border-color: #667eea;
    }
    .dark-mode #baiduTargetText {
      background: #1e2d3d;
      color: #cfd8dc;
      border-color: #37474f;
    }
    .dark-mode #baiduTargetText:focus {
      border-color: #64b5f6;
    }

    #baiduTranslateStatus {
      font-size: 12px;
      min-height: 18px;
      margin-top: 8px;
      padding-left: 2px;
      transition: color 0.2s;
    }

    /* Dark mode overrides */
    .dark-mode #baiduTranslationBox .category-section {
      background: #243447;
      border: 1px solid #2d3e52;
    }

    .dark-mode #baiduTranslationBox .category-title {
      color: #ef9a9a;
      border-bottom-color: #ef9a9a;
    }

    .dark-mode .baidu-hint {
      background: rgba(239, 154, 154, 0.08);
      border-left-color: #ef9a9a;
      color: #90a4ae;
    }

    .dark-mode #baiduSourceLang {
      background: #1a2332;
      border-color: #2d3e52;
      color: #b0bec5;
    }

    .dark-mode #baiduSourceLang:focus {
      border-color: #ef9a9a;
      box-shadow: 0 0 0 3px rgba(239, 154, 154, 0.15);
    }

    .dark-mode #baiduSourceText {
      background: #1a2332;
      border-color: #2d3e52;
      color: #b0bec5;
    }

    .dark-mode #baiduSourceText:focus {
      border-color: #ef9a9a;
      box-shadow: 0 0 0 3px rgba(239, 154, 154, 0.15);
    }

    .dark-mode #baiduSourceText::placeholder {
      color: #546e7a;
    }

    .dark-mode #baiduOpenBtn {
      background: linear-gradient(135deg, #8b0000 0%, #5d0000 100%);
      box-shadow: 0 2px 8px rgba(139, 0, 0, 0.4);
    }

    .dark-mode #baiduOpenBtn:hover {
      background: linear-gradient(135deg, #a00000 0%, #6e0000 100%);
      box-shadow: 0 4px 14px rgba(160, 0, 0, 0.5);
    }

    .dark-mode #baiduTranslateStatus {
      color: #78909c;
    }
  </style>
</head>

<body>
  <div id="focusOverlay" class="focus-overlay"></div>
  <div id="stars-container">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>
  </div>
  <div class="popup-overlay" id="popupOverlay"></div>

  <div class="search-container">
    <div class="search-bar">
      <form id="searchForm">
        <div id="searchSource">Entrez une requête pour afficher la source</div>
        <button type="button" id="siteBtn" class="site-btn" aria-pressed="false">
          <span class="site-btn-g site-btn-g-off">G</span>
          <img src="https://www.google.com/favicon.ico" alt="Google" class="site-btn-logo site-btn-g-on">
          site:
        </button>
        <div class="autocomplete-container">
          <img id="search-prefix-favicon" src="https://www.google.com/s2/favicons?sz=64&domain=google.com" alt="favicon" title="Moteur actif">
          <input type="text" id="searchInput" autocomplete="off" placeholder="Commencez votre recherche ici..." />
          <div id="bang-indicator" role="status" aria-live="polite">
            <span class="bang-arrow">⚡</span>
            <span class="bang-engine"></span>
            <span class="bang-hint">↵ to search</span>
          </div>
        </div>
        <button type="submit">🔍</button>
        <div id="langIcon" class="lang-icon" title="Select output language">🌐</div>
        <button type="button" id="filetypesBtn">📁 Filetypes</button>
        <button type="button" id="duckBangBtn" style="display: none;">🦆 !bang</button>
      </form>
    </div>

    <!-- YouTube Filters -->
    <div id="youtubeFilters" style="display: none;">
      <div class="category-section">
        <div class="category-title">🔽 Trier par</div>
        <div class="radio-group">
          <label><input type="radio" name="yt_sort" value="" checked> Pertinence</label>
          <label><input type="radio" name="yt_sort" value="CAI%3D"> Date d'ajout</label>
          <label><input type="radio" name="yt_sort" value="CAM%3D"> Nombre de vues</label>
          <label><input type="radio" name="yt_sort" value="CAE%3D"> Note</label>
        </div>
      </div>
      <div class="category-section">
        <div class="category-title">📁 Type</div>
        <div class="radio-group">
          <label><input type="radio" name="yt_type" value="" checked> Tout</label>
          <label><input type="radio" name="yt_type" value="EgIQAQ%253D%253D"> Vidéo</label>
          <label><input type="radio" name="yt_type" value="EgIQAg%253D%253D"> Chaîne</label>
          <label><input type="radio" name="yt_type" value="EgIQAw%253D%253D"> Playlist</label>
        </div>
      </div>
      <div class="category-section">
        <div class="category-title">🏱️ Durée</div>
        <div class="radio-group">
          <label><input type="radio" name="yt_duration" value="" checked> Indifférent</label>
          <label><input type="radio" name="yt_duration" value="EgIYAQ%253D%253D"> &lt; 4 min</label>
          <label><input type="radio" name="yt_duration" value="EgIYAw%253D%253D"> 4-20 min</label>
          <label><input type="radio" name="yt_duration" value="EgIYAg%253D%253D"> &gt; 20 min</label>
        </div>
      </div>
      <div class="category-section">
        <div class="category-title">📅 Date d'ajout</div>
        <div class="radio-group">
          <label><input type="radio" name="yt_date" value="" checked> Indifférent</label>
          <label><input type="radio" name="yt_date" value="EgIIAQ%253D%253D"> Dernière heure</label>
          <label><input type="radio" name="yt_date" value="EgIIAg%253D%253D"> Aujourd'hui</label>
          <label><input type="radio" name="yt_date" value="EgIIAw%253D%253D"> Cette semaine</label>
          <label><input type="radio" name="yt_date" value="EgIIBA%253D%253D"> Ce mois-ci</label>
          <label><input type="radio" name="yt_date" value="EgIIBQ%253D%253D"> Cette année</label>
        </div>
      </div>
    </div>

    <!-- Google Operator Filters -->
    <div id="googleOperatorFilters" style="display: none;">
      <div class="category-section">
        <div class="category-title">Basic Operators</div>
        <div class="operators-group">
          <button class="operator-btn" data-operator='" "'>"phrase"</button>
          <button class="operator-btn" data-operator="OR">OR</button>
          <button class="operator-btn" data-operator="-">-term</button>
          <button class="operator-btn" data-operator="*">*</button>
          <button class="operator-btn" data-operator="( )">(group)</button>
          <button class="operator-btn" data-operator="in">in</button>
        </div>
      </div>
      <div class="category-section">
        <div class="category-title">Advanced Operators</div>
        <div class="operators-group">
          <button class="operator-btn" data-operator="site:">site:</button>
          <button class="operator-btn" data-operator="intitle:">intitle:</button>
          <button class="operator-btn" data-operator="allintitle:">allintitle:</button>
          <button class="operator-btn" data-operator="inurl:">inurl:</button>
          <button class="operator-btn" data-operator="allinurl:">allinurl:</button>
          <button class="operator-btn" data-operator="intext:">intext:</button>
          <button class="operator-btn" data-operator="allintext:">allintext:</button>
          <button class="operator-btn" data-operator="filetype:">filetype:</button>
          <button class="operator-btn" data-operator="related:">related:</button>
        </div>
      </div>
      <div class="category-section">
        <div class="category-title">Specialized Operators</div>
        <div class="operators-group">
          <button class="operator-btn" data-operator="define:">define:</button>
          <button class="operator-btn" data-operator="source:">source:</button>
          <button class="operator-btn" data-operator="stocks:">stocks:</button>
          <button class="operator-btn" data-operator="weather:">weather:</button>
          <button class="operator-btn" data-operator="before:">before:</button>
          <button class="operator-btn" data-operator="after:">after:</button>
          <button class="operator-btn" data-operator="AROUND()">AROUND()</button>
        </div>
      </div>
    </div>

    <!-- Bing Operator Filters -->
    <div id="bingOperatorFilters" style="display: none;">
      <div class="category-section">
        <div class="category-title">Basic Operators</div>
        <div class="operators-group">
          <button class="operator-btn" data-operator='" "'>"phrase"</button>
          <button class="operator-btn" data-operator="OR">OR</button>
          <button class="operator-btn" data-operator="NOT">NOT</button>
        </div>
      </div>
      <div class="category-section">
        <div class="category-title">Advanced Operators</div>
        <div class="operators-group">
          <button class="operator-btn" data-operator="site:">site:</button>
          <button class="operator-btn" data-operator="filetype:">filetype:</button>
          <button class="operator-btn" data-operator="inurl:">inurl:</button>
          <button class="operator-btn" data-operator="inbody:">inbody:</button>
          <button class="operator-btn" data-operator="intitle:">intitle:</button>
        </div>
      </div>
      <div class="category-section">
        <div class="category-title">Specialized Operators</div>
        <div class="operators-group">
          <button class="operator-btn" data-operator="define:">define:</button>
          <button class="operator-btn" data-operator="imagesize:">imagesize:</button>
          <button class="operator-btn" data-operator="feed:">feed:</button>
          <button class="operator-btn" data-operator="language:">language:</button>
        </div>
      </div>
    </div>

    <!-- CISMeF Filters -->
    <div id="cismefFilters" style="display: none;">
      <div class="category-section">
        <div class="category-title">⚕️ CISMeF - Type de document</div>
        <div class="radio-group">
          <label><input type="radio" name="cismef_scope" value="env=basic&q=" checked> Tous les types</label>
          <label><input type="radio" name="cismef_scope" value="env=bp&q="> Uniquement les recommandations professionnelles</label>
          <label><input type="radio" name="cismef_scope" value="env=unf3s&q="> Documents d'enseignement</label>
          <label><input type="radio" name="cismef_scope" value="env=pat&q="> Documents grand public et les associations de patients</label>
          <label><input type="radio" name="cismef_scope" value="env=thm&q="> Thèses et mémoires</label>
          <label><input type="radio" name="cismef_scope" value="env=ecn&q=a&p="> Épreuves Classantes Nationales (nouveau programme 2022)</label>
        </div>
      </div>
    </div>

    <!-- AMMPS Filters -->
    <div id="ammpsFilters" style="display: none;">
      <div class="category-section">
        <div class="category-title">🇲🇦 AMMPS — Agence Marocaine des Médicaments et des Produits de Santé</div>
        <div class="radio-group">
          <label><input type="radio" name="ammps_scope" value="ammps:" checked> BASE DE DONNÉES DES MÉDICAMENTS</label>
          <label><input type="radio" name="ammps_scope" value="ammps-lm:"> LISTE DES MÉDICAMENTS</label>
          <label><input type="radio" name="ammps_scope" value="ammps-rmmg:"> RÉPERTOIRE MAROCAIN DES MÉDICAMENTS GÉNÉRIQUES <small style="opacity:0.65">(recherche Google)</small></label>
          <label><input type="radio" name="ammps_scope" value="ammps-lvl:"> LA LISTE DES VACCINS LIBÉRÉS</label>
          <label><input type="radio" name="ammps_scope" value="ammps-p:"> PHARMACIES</label>
          <label><input type="radio" name="ammps_scope" value="ammps-gs:"> site:AMMPS <small style="opacity:0.65">(recherche Google)</small></label>
        </div>
      </div>
    </div>

    <!-- Yandex Translation Box -->
    <div id="yandexTranslationBox" style="display: none;">
      <div class="category-section">
        <div class="category-title">🇷🇺 Yandex Translate — Русский</div>

        <div class="yandex-hint">
          💡 Type your text below — it auto-translates to <strong>Russian</strong> using a 3-layer fallback: Google Translate → LibreTranslate → MyMemory (500 ms debounce). Leave the text empty to open Yandex Translate directly.
        </div>

        <div class="yandex-controls-row">
          <select id="yandexSourceLang" title="Source language">
            <option value="en" selected>English → Russian</option>
            <option value="fr">French → Russian</option>
            <option value="de">German → Russian</option>
            <option value="es">Spanish → Russian</option>
            <option value="ar">Arabic → Russian</option>
            <option value="zh">Chinese → Russian</option>
            <option value="it">Italian → Russian</option>
            <option value="pt">Portuguese → Russian</option>
          </select>
          <input
            type="text"
            id="yandexSourceText"
            placeholder="Enter text to translate… (or leave empty to open Yandex Translate)"
            autocomplete="off"
          />
        </div>

        <textarea
          id="yandexTargetText"
          readonly
          placeholder="Russian translation will appear here…"
        ></textarea>

        <div class="yandex-buttons-row">
          <button type="button" id="yandexOpenBtn">🔗 Open in Yandex Translate</button>
          <button type="button" id="yandexInsertBtn" class="operator-btn">↩ Insert into search</button>
          <button type="button" id="yandexCopyBtn" class="operator-btn">📋 Copy</button>
          <button type="button" id="yandexTranslateSearchBtn" title="Translate search bar to Russian (Alt+V)">🔄 Translate search bar</button>
        </div>

        <div id="yandexTranslateStatus"></div>
      </div>
    </div>

    <!-- ✅ NEW: Baidu Fanyi Translation Box -->
    <div id="baiduTranslationBox">
      <div class="category-section">
        <div class="category-title">🇨🇳 Baidu Fanyi — 翻译</div>

        <div class="baidu-hint">
          💡 Auto-translates using a 3-layer fallback: <strong>Google Translate → LibreTranslate → MyMemory</strong> (500 ms debounce). "🔗 Open in Baidu Fanyi" is available as a manual backup if all APIs fail.
        </div>

        <div class="baidu-controls-row">
          <select id="baiduSourceLang" title="Translation direction">
            <option value="auto2zh" selected>Auto → Chinese 中文</option>
            <option value="auto2en">Auto → English</option>
            <option value="en2zh">English → Chinese 中文</option>
            <option value="zh2en">Chinese 中文 → English</option>
            <option value="fr2zh">French → Chinese 中文</option>
            <option value="ar2zh">Arabic → Chinese 中文</option>
          </select>
          <input
            type="text"
            id="baiduSourceText"
            placeholder="Enter text to translate… (or leave empty to open Baidu Fanyi)"
            autocomplete="off"
          />
        </div>

        <textarea
          id="baiduTargetText"
          rows="3"
          placeholder="Translation will appear here…"
          readonly
        ></textarea>

        <div class="baidu-buttons-row">
          <button type="button" id="baiduOpenBtn">🔗 Open in Baidu Fanyi</button>
          <button type="button" id="baiduCopyBtn" class="operator-btn">📋 Copy translation</button>
          <button type="button" id="baiduInsertBtn" class="operator-btn">↩ Insert into search</button>
          <button type="button" id="baiduTranslateSearchBtn" title="Translate search bar to Chinese (Alt+V)">🔄 Translate search bar</button>
        </div>

        <div id="baiduTranslateStatus"></div>
      </div>
    </div>

    <!-- Engine Category Cards -->
    <div class="category-row">
      <div class="category-section">
        <div class="category-title">🌐 Recherche Générale</div>
        <div class="radio-group" id="group1">
          <label><input type="radio" name="searchEngine" value="g:" checked>Google</label>
          <label><input type="radio" name="searchEngine" value="yt:">YouTube</label>
          <label><input type="radio" name="searchEngine" value="brave:">Brave Search</label>
          <label><input type="radio" name="searchEngine" value="ddg:">DuckDuckGo</label>
          <label><input type="radio" name="searchEngine" value="yan:">Yandex</label>
          <label><input type="radio" name="searchEngine" value="bing:">Bing</label>
          <label><input type="radio" name="searchEngine" value="bd:">Baidu</label>
          <label><input type="radio" name="searchEngine" value="gplus:">Google Avancé</label>
          <label><input type="radio" name="searchEngine" value="wiki:">Wikipedia</label>
          <label><input type="radio" name="searchEngine" value="bdbk:">Baidu Baike (wiki)</label>
          <label><input type="radio" name="searchEngine" value="grokw:">Grokipedia</label>
          <label><input type="radio" name="searchEngine" value="ww:">WikiWand</label>
        </div>
      </div>

      <div class="category-section">
        <div class="category-title">🎓 Académique / Thèses</div>
        <div class="radio-group" id="group2">
          <label><input type="radio" name="searchEngine" value="scholar:">Google Scholar</label>
          <label><input type="radio" name="searchEngine" value="pubmed:">PubMed</label>
          <label><input type="radio" name="searchEngine" value="arxiv:">arXiv</label>
          <label><input type="radio" name="searchEngine" value="gpat:">Google Patents</label>
          <label><input type="radio" name="searchEngine" value="these2.0:">These2.0</label>
          <label><input type="radio" name="searchEngine" value="cismef-th:">CISMeF Thèses</label>
          <label><input type="radio" name="searchEngine" value="these-ma:">Toubkal</label>
          <label><input type="radio" name="searchEngine" value="these-fr:">Theses.fr</label>
          <label><input type="radio" name="searchEngine" value="rgate:">ResearchGate</label>
          <label><input type="radio" name="searchEngine" value="ndltd:">NDLTD</label>
          <label><input type="radio" name="searchEngine" value="proinserm:">Pro Inserm</label>
          <label><input type="radio" name="searchEngine" value="bdedu:">Baidu Scholar (Xueshu)</label>
        </div>
      </div>

      <div class="category-section">
        <div class="category-title">⚕️ Médical / Santé</div>
        <div class="radio-group" id="group3">
          <label><input type="radio" name="searchEngine" value="cismef:">CISMeF</label>
          <label><input type="radio" name="searchEngine" value="msps:">Ministère de la santé et de la Protection Sociale</label>
          <label><input type="radio" name="searchEngine" value="ammps:">AMMPS</label>
          <label><input type="radio" name="searchEngine" value="has:">HAS</label>
          <label><input type="radio" name="searchEngine" value="vidal:">VIDAL</label>
          <label><input type="radio" name="searchEngine" value="mesh:">MeSH Browser</label>
          <label><input type="radio" name="searchEngine" value="lissa:">LISSA</label>
          <label><input type="radio" name="searchEngine" value="anm:">Académie nationale de médecine</label>
          <label><input type="radio" name="searchEngine" value="hetop:">HETOP</label>
          <label><input type="radio" name="searchEngine" value="nejm:">New England Journal of Medicine</label>
          <label><input type="radio" name="searchEngine" value="rp:">Radiopaedia</label>
          <label><input type="radio" name="searchEngine" value="utd:">UpToDate</label>
          <label><input type="radio" name="searchEngine" value="coch:">Cochrane Library</label>
          <label><input type="radio" name="searchEngine" value="medscape:">Medscape</label>
          <label><input type="radio" name="searchEngine" value="openmd:">OpenMD</label>
          <label><input type="radio" name="searchEngine" value="dd:">Diseases Database</label>
          <label><input type="radio" name="searchEngine" value="webmd:">WebMD</label>
          <label><input type="radio" name="searchEngine" value="nih:">NIH</label>
          <label><input type="radio" name="searchEngine" value="drugs:">Drugs.com</label>
          <label><input type="radio" name="searchEngine" value="cdc:">CDC</label>
        </div>
      </div>

      <div class="category-section">
        <div class="category-title">🤖 IA / Avancé</div>
        <div class="radio-group" id="group4">
          <label><input type="radio" name="searchEngine" value="wolf:">Wolfram Alpha</label>
          <label><input type="radio" name="searchEngine" value="chatgpt:">ChatGPT</label>
          <label><input type="radio" name="searchEngine" value="claude:">Claude AI 📋</label>
          <label><input type="radio" name="searchEngine" value="gemini:">Gemini 📋</label>
          <label><input type="radio" name="searchEngine" value="gai:">Google AI Mode</label>
          <label><input type="radio" name="searchEngine" value="perplexity:">Perplexity</label>
          <label><input type="radio" name="searchEngine" value="copilot:">Copilot 📋</label>
          <label><input type="radio" name="searchEngine" value="cbd:">Chat Baidu</label>
          <label><input type="radio" name="searchEngine" value="ernie:">Baidu AI 📋</label>
          <label><input type="radio" name="searchEngine" value="duckai:">Duck.ai</label>
        </div>
      </div>
    </div>

    <!-- Wiki Content -->
    <div id="wikiContent" role="region" aria-label="Wiki des préfixes">
      <div class="wiki-header">
        <div class="wiki-header-top">
          <div class="wiki-keep-open">
            <input type="checkbox" id="keepWikiOpenCheckbox" />
            <label for="keepWikiOpenCheckbox">Garder ouvert</label>
          </div>
          <div class="wiki-search-wrap">
            <span class="wiki-search-icon">🔍</span>
            <input type="text" id="wikiSearchInput" placeholder="Filter engines… (type prefix or name)" autocomplete="off" spellcheck="false" />
            <button type="button" id="wikiSearchClear" aria-label="Clear filter">✕</button>
          </div>
        </div>
        <div class="wiki-cat-tabs" role="tablist" aria-label="Filter by category">
          <button class="wiki-cat-tab active" data-cat="all" role="tab" aria-selected="true">All</button>
          <button class="wiki-cat-tab" data-cat="general" role="tab" aria-selected="false">🌐 General</button>
          <button class="wiki-cat-tab" data-cat="academic" role="tab" aria-selected="false">🎓 Academic</button>
          <button class="wiki-cat-tab" data-cat="medical" role="tab" aria-selected="false">⚕️ Medical</button>
          <button class="wiki-cat-tab" data-cat="ai" role="tab" aria-selected="false">🤖 AI</button>
        </div>
      </div>

      <div id="wikiGrid" class="wiki-grid">
        <div class="wiki-section" data-section="general">
          <div class="wiki-section-title">🌐 Recherche Générale</div>
          <div class="wiki-chips">
            <div class="wiki-chip" data-prefix="g:" data-cat="general" data-name="Google"><span class="wiki-chip-prefix">g:</span><span class="wiki-chip-name">Google</span></div>
            <div class="wiki-chip" data-prefix="yt:" data-cat="general" data-name="YouTube"><span class="wiki-chip-prefix">yt:</span><span class="wiki-chip-name">YouTube</span></div>
            <div class="wiki-chip" data-prefix="brave:" data-cat="general" data-name="Brave Search"><span class="wiki-chip-prefix">brave:</span><span class="wiki-chip-name">Brave Search</span></div>
            <div class="wiki-chip" data-prefix="ddg:" data-cat="general" data-name="DuckDuckGo"><span class="wiki-chip-prefix">ddg:</span><span class="wiki-chip-name">DuckDuckGo</span></div>
            <div class="wiki-chip" data-prefix="yan:" data-cat="general" data-name="Yandex"><span class="wiki-chip-prefix">yan:</span><span class="wiki-chip-name">Yandex</span></div>
            <div class="wiki-chip" data-prefix="bing:" data-cat="general" data-name="Bing"><span class="wiki-chip-prefix">bing:</span><span class="wiki-chip-name">Bing</span></div>
            <div class="wiki-chip" data-prefix="bd:" data-cat="general" data-name="Baidu"><span class="wiki-chip-prefix">bd:</span><span class="wiki-chip-name">Baidu</span></div>
            <div class="wiki-chip" data-prefix="gplus:" data-cat="general" data-name="Google Avancé"><span class="wiki-chip-prefix">gplus:</span><span class="wiki-chip-name">Google Avancé</span></div>
          </div>
        </div>

        <div class="wiki-section" data-section="academic">
          <div class="wiki-section-title">🎓 Académique / Thèses</div>
          <div class="wiki-chips">
            <div class="wiki-chip" data-prefix="scholar:" data-cat="academic" data-name="Google Scholar"><span class="wiki-chip-prefix">scholar:</span><span class="wiki-chip-name">Google Scholar</span></div>
            <div class="wiki-chip" data-prefix="pubmed:" data-cat="academic" data-name="PubMed"><span class="wiki-chip-prefix">pubmed:</span><span class="wiki-chip-name">PubMed</span></div>
            <div class="wiki-chip" data-prefix="arxiv:" data-cat="academic" data-name="arXiv"><span class="wiki-chip-prefix">arxiv:</span><span class="wiki-chip-name">arXiv</span></div>
            <div class="wiki-chip" data-prefix="gpat:" data-cat="academic" data-name="Google Patents"><span class="wiki-chip-prefix">gpat:</span><span class="wiki-chip-name">Google Patents</span></div>
            <div class="wiki-chip" data-prefix="these2.0:" data-cat="academic" data-name="These2.0"><span class="wiki-chip-prefix">these2.0:</span><span class="wiki-chip-name">These2.0</span></div>
            <div class="wiki-chip" data-prefix="cismef-th:" data-cat="academic" data-name="CISMeF Thèses"><span class="wiki-chip-prefix">cismef-th:</span><span class="wiki-chip-name">CISMeF Thèses</span></div>
            <div class="wiki-chip" data-prefix="these-ma:" data-cat="academic" data-name="Toubkal"><span class="wiki-chip-prefix">these-ma:</span><span class="wiki-chip-name">Toubkal</span></div>
            <div class="wiki-chip" data-prefix="these-fr:" data-cat="academic" data-name="Theses.fr"><span class="wiki-chip-prefix">these-fr:</span><span class="wiki-chip-name">Theses.fr</span></div>
            <div class="wiki-chip" data-prefix="rgate:" data-cat="academic" data-name="ResearchGate"><span class="wiki-chip-prefix">rgate:</span><span class="wiki-chip-name">ResearchGate</span></div>
            <div class="wiki-chip" data-prefix="ndltd:" data-cat="academic" data-name="NDLTD"><span class="wiki-chip-prefix">ndltd:</span><span class="wiki-chip-name">NDLTD</span></div>
            <div class="wiki-chip" data-prefix="proinserm:" data-cat="academic" data-name="Pro Inserm"><span class="wiki-chip-prefix">proinserm:</span><span class="wiki-chip-name">Pro Inserm</span></div>
            <div class="wiki-chip" data-prefix="bdedu:" data-cat="academic" data-name="Baidu Scholar"><span class="wiki-chip-prefix">bdedu:</span><span class="wiki-chip-name">Baidu Scholar</span></div>
          </div>
        </div>

        <div class="wiki-section" data-section="medical">
          <div class="wiki-section-title">⚕️ Médical / Santé</div>
          <div class="wiki-chips">
            <div class="wiki-chip" data-prefix="cismef:" data-cat="medical" data-name="CISMeF"><span class="wiki-chip-prefix">cismef:</span><span class="wiki-chip-name">CISMeF</span></div>
            <div class="wiki-chip" data-prefix="cismef-bp:" data-cat="medical" data-name="CISMeF Bonnes Pratiques"><span class="wiki-chip-prefix">cismef-bp:</span><span class="wiki-chip-name">CISMeF BP</span></div>
            <div class="wiki-chip" data-prefix="cismef-edu:" data-cat="medical" data-name="CISMeF Éducation"><span class="wiki-chip-prefix">cismef-edu:</span><span class="wiki-chip-name">CISMeF Édu</span></div>
            <div class="wiki-chip" data-prefix="cismef-edn:" data-cat="medical" data-name="CISMeF ECN"><span class="wiki-chip-prefix">cismef-edn:</span><span class="wiki-chip-name">CISMeF ECN</span></div>
            <div class="wiki-chip" data-prefix="cismef-pat:" data-cat="medical" data-name="CISMeF Patients"><span class="wiki-chip-prefix">cismef-pat:</span><span class="wiki-chip-name">CISMeF Pat.</span></div>
            <div class="wiki-chip" data-prefix="msps:" data-cat="medical" data-name="Ministère Santé Maroc"><span class="wiki-chip-prefix">msps:</span><span class="wiki-chip-name">Min. Santé MA</span></div>
            <div class="wiki-chip" data-prefix="has:" data-cat="medical" data-name="HAS"><span class="wiki-chip-prefix">has:</span><span class="wiki-chip-name">HAS</span></div>
            <div class="wiki-chip" data-prefix="vidal:" data-cat="medical" data-name="VIDAL"><span class="wiki-chip-prefix">vidal:</span><span class="wiki-chip-name">VIDAL</span></div>
            <div class="wiki-chip" data-prefix="mesh:" data-cat="medical" data-name="MeSH Browser"><span class="wiki-chip-prefix">mesh:</span><span class="wiki-chip-name">MeSH Browser</span></div>
            <div class="wiki-chip" data-prefix="lissa:" data-cat="medical" data-name="LISSA"><span class="wiki-chip-prefix">lissa:</span><span class="wiki-chip-name">LISSA</span></div>
            <div class="wiki-chip" data-prefix="anm:" data-cat="medical" data-name="Académie Médecine"><span class="wiki-chip-prefix">anm:</span><span class="wiki-chip-name">Acad. Médecine</span></div>
            <div class="wiki-chip" data-prefix="hetop:" data-cat="medical" data-name="HETOP"><span class="wiki-chip-prefix">hetop:</span><span class="wiki-chip-name">HETOP</span></div>
            <div class="wiki-chip" data-prefix="nejm:" data-cat="medical" data-name="NEJM"><span class="wiki-chip-prefix">nejm:</span><span class="wiki-chip-name">NEJM</span></div>
            <div class="wiki-chip" data-prefix="rp:" data-cat="medical" data-name="Radiopaedia"><span class="wiki-chip-prefix">rp:</span><span class="wiki-chip-name">Radiopaedia</span></div>
            <div class="wiki-chip" data-prefix="utd:" data-cat="medical" data-name="UpToDate"><span class="wiki-chip-prefix">utd:</span><span class="wiki-chip-name">UpToDate</span></div>
            <div class="wiki-chip" data-prefix="coch:" data-cat="medical" data-name="Cochrane Library"><span class="wiki-chip-prefix">coch:</span><span class="wiki-chip-name">Cochrane</span></div>
            <div class="wiki-chip" data-prefix="medscape:" data-cat="medical" data-name="Medscape"><span class="wiki-chip-prefix">medscape:</span><span class="wiki-chip-name">Medscape</span></div>
            <div class="wiki-chip" data-prefix="openmd:" data-cat="medical" data-name="OpenMD"><span class="wiki-chip-prefix">openmd:</span><span class="wiki-chip-name">OpenMD</span></div>
            <div class="wiki-chip" data-prefix="dd:" data-cat="medical" data-name="Diseases Database"><span class="wiki-chip-prefix">dd:</span><span class="wiki-chip-name">Diseases DB</span></div>
            <div class="wiki-chip" data-prefix="webmd:" data-cat="medical" data-name="WebMD"><span class="wiki-chip-prefix">webmd:</span><span class="wiki-chip-name">WebMD</span></div>
            <div class="wiki-chip" data-prefix="nih:" data-cat="medical" data-name="NIH"><span class="wiki-chip-prefix">nih:</span><span class="wiki-chip-name">NIH</span></div>
            <div class="wiki-chip" data-prefix="drugs:" data-cat="medical" data-name="Drugs.com"><span class="wiki-chip-prefix">drugs:</span><span class="wiki-chip-name">Drugs.com</span></div>
            <div class="wiki-chip" data-prefix="cdc:" data-cat="medical" data-name="CDC"><span class="wiki-chip-prefix">cdc:</span><span class="wiki-chip-name">CDC</span></div>
          </div>
        </div>

        <div class="wiki-section" data-section="ai">
          <div class="wiki-section-title">🤖 IA / Avancé</div>
          <div class="wiki-chips">
            <div class="wiki-chip" data-prefix="wolf:" data-cat="ai" data-name="Wolfram Alpha"><span class="wiki-chip-prefix">wolf:</span><span class="wiki-chip-name">Wolfram Alpha</span></div>
            <div class="wiki-chip" data-prefix="chatgpt:" data-cat="ai" data-name="ChatGPT"><span class="wiki-chip-prefix">chatgpt:</span><span class="wiki-chip-name">ChatGPT</span></div>
            <div class="wiki-chip" data-prefix="claude:" data-cat="ai" data-name="Claude AI"><span class="wiki-chip-prefix">claude:</span><span class="wiki-chip-name">Claude AI</span></div>
            <div class="wiki-chip" data-prefix="gemini:" data-cat="ai" data-name="Gemini"><span class="wiki-chip-prefix">gemini:</span><span class="wiki-chip-name">Gemini</span></div>
            <div class="wiki-chip" data-prefix="gai:" data-cat="ai" data-name="Google AI Mode"><span class="wiki-chip-prefix">gai:</span><span class="wiki-chip-name">Google AI</span></div>
            <div class="wiki-chip" data-prefix="perplexity:" data-cat="ai" data-name="Perplexity"><span class="wiki-chip-prefix">perplexity:</span><span class="wiki-chip-name">Perplexity</span></div>
            <div class="wiki-chip" data-prefix="copilot:" data-cat="ai" data-name="Copilot"><span class="wiki-chip-prefix">copilot:</span><span class="wiki-chip-name">Copilot</span></div>
            <div class="wiki-chip" data-prefix="cbd:" data-cat="ai" data-name="Chat Baidu"><span class="wiki-chip-prefix">cbd:</span><span class="wiki-chip-name">Chat Baidu</span></div>
            <div class="wiki-chip" data-prefix="ernie:" data-cat="ai" data-name="Baidu AI"><span class="wiki-chip-prefix">ernie:</span><span class="wiki-chip-name">Baidu AI</span></div>
            <div class="wiki-chip" data-prefix="duckai:" data-cat="ai" data-name="Duck.ai"><span class="wiki-chip-prefix">duckai:</span><span class="wiki-chip-name">Duck.ai</span></div>
          </div>
        </div>

        <div id="wikiEmptyState" class="wiki-empty" style="display:none;">
          <span>No engines match "<span id="wikiEmptyQuery"></span>"</span>
        </div>
      </div>

      <div class="wiki-hint">💡 Click a chip to select that engine · Type the prefix directly in the search bar</div>
    </div>

    <!-- Google Wiki Popup -->
    <div id="googleWikiPopup" style="display: none;">
      <button class="close-btn" id="closeGoogleWikiBtn">&times;</button>
      <h3>Google Search Operators Wiki</h3>
      <div class="checkbox-container" style="padding-bottom: 10px; margin-bottom: 10px; border-bottom: 1px solid #e0e0e0;">
        <input type="checkbox" id="keepGoogleWikiOpenCheckbox" />
        <label for="keepGoogleWikiOpenCheckbox">Keep wiki open</label>
      </div>
      <p>Search operators are special words and symbols to refine search results.</p>
      <div style="max-height: 50vh; overflow-y: auto;">
        <h4>Basic Operators</h4>
        <table class="wiki-table">
          <thead><tr><th>Operator</th><th>Description</th></tr></thead>
          <tbody>
            <tr><td><code>"phrase"</code></td><td>Searches for an exact phrase match.</td></tr>
            <tr><td><code>OR</code> or <code>|</code></td><td>Returns results containing either term.</td></tr>
            <tr><td><code>-term</code></td><td>Excludes results containing the term.</td></tr>
            <tr><td><code>*</code></td><td>Wildcard for any word or phrase.</td></tr>
            <tr><td><code>( )</code></td><td>Groups terms to control search logic.</td></tr>
            <tr><td><code>in</code></td><td>Converts units or currencies.</td></tr>
          </tbody>
        </table>
        <h4>Advanced Operators</h4>
        <table class="wiki-table">
          <thead><tr><th>Operator</th><th>Description</th></tr></thead>
          <tbody>
            <tr><td><code>site:</code></td><td>Restricts results to a specific site.</td></tr>
            <tr><td><code>intitle:</code></td><td>Term must appear in the page title.</td></tr>
            <tr><td><code>allintitle:</code></td><td>All terms must appear in the page title.</td></tr>
            <tr><td><code>inurl:</code></td><td>Term must be in the page's URL.</td></tr>
            <tr><td><code>allinurl:</code></td><td>All terms must be in the URL.</td></tr>
            <tr><td><code>intext:</code></td><td>Term must be in the page body text.</td></tr>
            <tr><td><code>allintext:</code></td><td>All terms must be in the body text.</td></tr>
            <tr><td><code>filetype:</code></td><td>Limits results to specific file types.</td></tr>
            <tr><td><code>related:</code></td><td>Finds sites similar to a given domain.</td></tr>
          </tbody>
        </table>
        <h4>Specialized Operators</h4>
        <table class="wiki-table">
          <thead><tr><th>Operator</th><th>Description</th></tr></thead>
          <tbody>
            <tr><td><code>define:</code></td><td>Displays definitions.</td></tr>
            <tr><td><code>source:</code></td><td>In Google News, filters by a specific outlet.</td></tr>
            <tr><td><code>stocks:</code></td><td>Fetches stock info.</td></tr>
            <tr><td><code>weather:</code></td><td>Shows weather for a location.</td></tr>
            <tr><td><code>before:/after:</code></td><td>Filters results before/after a date (YYYY-MM-DD).</td></tr>
            <tr><td><code>AROUND(n)</code></td><td>Finds terms within 'n' words of each other.</td></tr>
          </tbody>
        </table>
      </div>
      <div class="wiki-footer" style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #e0e0e0;">
        <p>Operators can be combined. See <a href="https://support.google.com/websearch/answer/2466433" target="_blank" rel="noopener noreferrer">Google's official documentation</a>.</p>
      </div>
    </div>

    <!-- Bing Wiki Popup -->
    <div id="bingWikiPopup" style="display: none;">
      <button class="close-btn" id="closeBingWikiBtn">&times;</button>
      <h3>Bing Search Operators Wiki</h3>
      <div class="checkbox-container" style="padding-bottom: 10px; margin-bottom: 10px; border-bottom: 1px solid #e0e0e0;">
        <input type="checkbox" id="keepBingWikiOpenCheckbox" />
        <label for="keepBingWikiOpenCheckbox">Keep wiki open</label>
      </div>
      <p>Bing search operators for more precise outcomes.</p>
      <div style="max-height: 50vh; overflow-y: auto;">
        <h4>Basic Operators</h4>
        <table class="wiki-table">
          <thead><tr><th>Operator</th><th>Description</th></tr></thead>
          <tbody>
            <tr><td><code>"phrase"</code></td><td>Searches for an exact phrase match.</td></tr>
            <tr><td><code>OR</code></td><td>Returns results containing either term.</td></tr>
            <tr><td><code>NOT</code> or <code>-</code></td><td>Excludes results containing the term.</td></tr>
          </tbody>
        </table>
        <h4>Advanced Operators</h4>
        <table class="wiki-table">
          <thead><tr><th>Operator</th><th>Description</th></tr></thead>
          <tbody>
            <tr><td><code>site:</code></td><td>Restricts results to a specific site.</td></tr>
            <tr><td><code>filetype:</code></td><td>Limits results to specific file types.</td></tr>
            <tr><td><code>inurl:</code></td><td>Term must be in the page's URL.</td></tr>
            <tr><td><code>inbody:</code></td><td>Term must be in the page body text.</td></tr>
            <tr><td><code>intitle:</code></td><td>Term must appear in the page title.</td></tr>
          </tbody>
        </table>
        <h4>Specialized Operators</h4>
        <table class="wiki-table">
          <thead><tr><th>Operator</th><th>Description</th></tr></thead>
          <tbody>
            <tr><td><code>define:</code></td><td>Displays definitions.</td></tr>
            <tr><td><code>imagesize:</code></td><td>Searches for images of a specific size.</td></tr>
            <tr><td><code>feed:</code></td><td>Returns RSS or Atom feeds.</td></tr>
            <tr><td><code>language:</code></td><td>Searches in a specific language.</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Bottom Buttons -->
    <div class="bottom-buttons" style="text-align: center; margin-top: 24px;">
      <button type="button" id="wikiToggleBtn">📖 Wiki</button>
      <button type="button" id="keyboardShortcutsBtn">⌨️</button>
      <button type="button" id="darkModeToggleBtn">🌙</button>
      <button type="button" id="googleWikiBtn" style="display: none;">📖 Google Wiki</button>
      <button type="button" id="bingWikiBtn" style="display: none;">📖 Bing Wiki</button>
      <button type="button" id="bangsBtn">!bangs</button>
    </div>

    <!-- Language Selection Popup -->
    <div id="langPopup" class="popup-overlay" style="display: none;">
      <div id="langPopupContent">
        <button class="close-btn" id="closeLangPopup">&times;</button>
        <h2>🌐 Translate Page</h2>
        <div class="lang-search-container">
          <input type="text" id="langSearchInput" placeholder="Type language name or code..." autocomplete="off" />
          <div id="langSuggestions"></div>
        </div>
        <div class="lang-buttons-grid">
          <button class="lang-btn" data-lang="original" title="No Translation">🌐 Original</button>
          <button class="lang-btn" data-lang="en" title="English">English</button>
          <button class="lang-btn" data-lang="fr" title="French">Français</button>
          <button class="lang-btn" data-lang="ar" title="Arabic">العربية</button>
          <button class="lang-btn" data-lang="ru" title="Russian">Русский</button>
          <button class="lang-btn" data-lang="es" title="Spanish">Español</button>
          <button class="lang-btn" data-lang="zh" title="Chinese">中文</button>
        </div>
        <p class="lang-info">Press <kbd>ESC</kbd> to close • Translation may not work for all engines</p>
      </div>
    </div>
  </div>

  <!-- Filetype Popup -->
  <div id="filetypesPopup" role="dialog" aria-modal="true" aria-labelledby="ft-popup-title">
    <div class="ft-popup-header">
      <div class="ft-header-left">
        <h3 id="ft-popup-title">📁 Select Filetypes</h3>
        <p>Select one or more — multiple choices are joined by OR</p>
      </div>
      <button class="close-btn" id="closeFiletypes" aria-label="Close">✕</button>
    </div>
    <div class="ft-popup-body">
      <div id="filetype-grid"></div>
    </div>
    <div class="ft-popup-footer">
      <span class="ft-selected-count" id="ft-selected-count">0 selected</span>
      <div class="ft-popup-footer-btns">
        <button type="button" id="clearFiletypes">Clear all</button>
        <button type="button" id="applyFiletypes">✓ Apply</button>
      </div>
    </div>
  </div>

  <!-- Keyboard Shortcuts Popup -->
  <div id="keyboardShortcutsPopup" role="dialog" aria-modal="true" aria-label="Keyboard Shortcuts">
    <div class="cheat-header">
      <span class="cheat-dot red" id="cheat-close-dot" title="Close" style="cursor:pointer;"></span>
      <span class="cheat-dot yellow"></span>
      <span class="cheat-dot green"></span>
      <div class="cheat-title">⌨&nbsp;<span>keybindings</span> — Search Interface</div>
    </div>
    <div class="cheat-body">
      <div class="cheat-grid">
        <div class="cheat-section">
          <div class="cheat-section-title">🔍 Search Bar</div>
          <div class="cheat-row">
            <div class="cheat-keys"><span class="kbd">Ctrl</span><span class="kbd-sep">+</span><span class="kbd">K</span></div>
            <div class="cheat-desc"><span class="hl">Focus</span> the search bar</div>
          </div>
          <div class="cheat-row">
            <div class="cheat-keys"><span class="kbd">Ctrl</span><span class="kbd-sep">+</span><span class="kbd">Shift</span><span class="kbd-sep">+</span><span class="kbd">K</span></div>
            <div class="cheat-desc"><span class="hl-orange">Clear</span> the search bar</div>
          </div>
          <div class="cheat-row">
            <div class="cheat-keys"><span class="kbd">Ctrl</span><span class="kbd-sep">+</span><span class="kbd">Shift</span><span class="kbd-sep">+</span><span class="kbd">C</span></div>
            <div class="cheat-desc"><span class="hl">Copy</span> current query to clipboard</div>
          </div>
          <div class="cheat-row">
            <div class="cheat-keys"><span class="kbd">Enter</span></div>
            <div class="cheat-desc"><span class="hl-green">Launch</span> search in new tab</div>
          </div>
        </div>
        <div class="cheat-section">
          <div class="cheat-section-title">🧭 Engine Navigation</div>
          <div class="cheat-row">
            <div class="cheat-keys"><span class="kbd">Alt</span><span class="kbd-sep">+</span><span class="kbd">↑</span><span class="kbd-sep">/</span><span class="kbd">↓</span></div>
            <div class="cheat-desc">Cycle through search engines</div>
          </div>
          <div class="cheat-row">
            <div class="cheat-keys"><span class="kbd">Alt</span><span class="kbd-sep">+</span><span class="kbd">1–4</span></div>
            <div class="cheat-desc">Jump to engine <span class="hl-blue">category</span></div>
          </div>
        </div>
        <div class="cheat-section">
          <div class="cheat-section-title">⚡ !bang Inline Routing</div>
          <div class="cheat-row">
            <div class="cheat-keys"><span class="kbd" style="font-size:11px">query !br</span></div>
            <div class="cheat-desc">Switch to <span class="hl-blue">Brave</span> mid-query</div>
          </div>
          <div class="cheat-row">
            <div class="cheat-keys"><span class="kbd" style="font-size:11px">!gpt query</span></div>
            <div class="cheat-desc">Route to <span class="hl-blue">ChatGPT</span> from start</div>
          </div>
          <div class="cheat-row">
            <div class="cheat-keys" style="flex-direction:column;align-items:flex-start;gap:2px;">
              <span style="font-size:10px;opacity:0.7;font-family:monospace">!g !yt !br !ddg !bing</span>
              <span style="font-size:10px;opacity:0.7;font-family:monospace">!sc !pm !ax !pat !rg</span>
              <span style="font-size:10px;opacity:0.7;font-family:monospace">!gpt !cl !gem !px !cop !wolf</span>
            </div>
            <div class="cheat-desc">Common bangs — unknown ones go to DDG</div>
          </div>
        </div>
        <div class="cheat-section">
          <div class="cheat-section-title">🟢 Google Site: Mode</div>
          <div class="cheat-row">
            <div class="cheat-keys"><span class="kbd">Alt</span><span class="kbd-sep">+</span><span class="kbd">G</span></div>
            <div class="cheat-desc"><span class="hl-green">One-shot</span> Google search</div>
          </div>
          <div class="cheat-row">
            <div class="cheat-keys"><span class="kbd">Alt</span><span class="kbd-sep">+</span><span class="kbd">Shift</span><span class="kbd-sep">+</span><span class="kbd">G</span></div>
            <div class="cheat-desc"><span class="hl-blue">Toggle</span> site: on / off</div>
          </div>
        </div>
        <div class="cheat-section">
          <div class="cheat-section-title">🌐 Translation</div>
          <div class="cheat-row">
            <div class="cheat-keys"><span class="kbd">Alt</span><span class="kbd-sep">+</span><span class="kbd">T</span></div>
            <div class="cheat-desc"><span class="hl">Open</span> translate popup</div>
          </div>
          <div class="cheat-row">
            <div class="cheat-keys"><span class="kbd">Alt</span><span class="kbd-sep">+</span><span class="kbd">O</span></div>
            <div class="cheat-desc">Search in <span class="hl-green">original</span> language</div>
          </div>
          <div class="cheat-row">
            <div class="cheat-keys"><span class="kbd">Alt</span><span class="kbd-sep">+</span><span class="kbd">F/E/A/S/R/C</span></div>
            <div class="cheat-desc">Set language → <span class="hl-blue">FR/EN/AR/ES/RU/ZH</span></div>
          </div>
          <div class="cheat-row">
            <div class="cheat-keys"><span class="kbd">Alt</span><span class="kbd-sep">+</span><span class="kbd">Shift</span><span class="kbd-sep">+</span><span class="kbd">O</span></div>
            <div class="cheat-desc"><span class="hl-orange">Reset</span> translation</div>
          </div>
        </div>
        <div class="cheat-section cheat-section-wide">
          <div class="cheat-section-title">🖥 Interface</div>
          <div class="cheat-row">
            <div class="cheat-keys"><span class="kbd">Esc</span></div>
            <div class="cheat-desc">Close any open popup</div>
          </div>
        </div>
      </div>
    </div>
    <div class="cheat-footer">
      <div><span class="cheat-esc">ESC</span>&nbsp;to close &nbsp;·&nbsp; all shortcuts work globally</div>
      <span class="cheat-count">15 bindings</span>
    </div>
  </div>

  <script>
    // ============================================
    // FILETYPE DATA
    // ============================================
    const filetypesWiki = {
      "📄 Documents & Text": [
        { ext: 'pdf', name: 'Adobe Portable Document Format' },
        { ext: ['doc', 'docx'], name: 'Microsoft Word' },
        { ext: 'rtf', name: 'Rich Text Format' },
        { ext: ['txt', 'text'], name: 'Plain Text' },
        { ext: 'odt', name: 'OpenDocument Text' },
        { ext: 'tex', name: 'LaTeX/TeX' },
        { ext: 'epub', name: 'Electronic Publication' },
        { ext: 'csv', name: 'Comma-Separated Values' },
        { ext: 'ps', name: 'Adobe PostScript' },
        { ext: ['wml', 'wap'], name: 'Wireless Markup Language' },
        { ext: 'xml', name: 'Extensible Markup Language' }
      ],
      "📊 Spreadsheets & Presentations": [
        { ext: ['xls', 'xlsx'], name: 'Microsoft Excel' },
        { ext: ['ppt', 'pptx'], name: 'Microsoft PowerPoint' },
        { ext: 'ods', name: 'OpenDocument Spreadsheet' },
        { ext: 'odp', name: 'OpenDocument Presentation' }
      ],
      "💻 Code & Web": [
        { ext: ['html', 'htm'], name: 'HTML' },
        { ext: 'py', name: 'Python' },
        { ext: 'js', name: 'JavaScript' },
        { ext: 'java', name: 'Java' },
        { ext: 'cpp', name: 'C++' },
        { ext: 'c', name: 'C / C Header' },
        { ext: 'h', name: 'C / C Header' },
        { ext: 'cs', name: 'C#' },
        { ext: 'pl', name: 'Perl' }
      ],
      "🖼️ Images": [
        { ext: 'jpg', name: 'JPEG image' },
        { ext: 'jpeg', name: 'JPEG image' },
        { ext: 'png', name: 'Portable Network Graphics' },
        { ext: 'gif', name: 'Graphics Interchange Format' },
        { ext: 'webp', name: 'WebP' },
        { ext: 'svg', name: 'Scalable Vector Graphics' },
        { ext: 'bmp', name: 'Bitmap' },
        { ext: 'avif', name: 'AV1 Image File Format' }
      ],
      "🎬 Video & Media": [
        { ext: 'mp4', name: 'MPEG-4 Video' },
        { ext: 'avi', name: 'AVI' },
        { ext: 'mov', name: 'Apple QuickTime Movie' },
        { ext: 'webm', name: 'WebM' },
        { ext: 'mkv', name: 'Matroska Video' },
        { ext: 'wmv', name: 'Windows Media Video' },
        { ext: 'mp3', name: 'MP3 Audio' },
        { ext: '3gp', name: '3GPP Multimedia' },
        { ext: '3g2', name: '3GPP Multimedia' },
        { ext: 'asf', name: 'Advanced Systems Format' },
        { ext: 'divx', name: 'DivX Video' },
        { ext: 'm2v', name: 'MPEG Video & Playlist' },
        { ext: 'm3u', name: 'MPEG Video & Playlist' },
        { ext: 'm3u8', name: 'MPEG Video & Playlist' },
        { ext: 'm4v', name: 'MPEG-4 Video' },
        { ext: 'ogv', name: 'Ogg Video' },
        { ext: 'qvt', name: 'QVT' },
        { ext: 'ram', name: 'Real Audio Media' },
        { ext: 'rm', name: 'Real Media' },
        { ext: 'vob', name: 'DVD Video Object' }
      ],
      "🗺️ Niche & Specialized": [
        { ext: 'kml', name: 'Keyhole Markup Language' },
        { ext: 'kmz', name: 'Keyhole Markup Language' },
        { ext: 'gpx', name: 'GPS Exchange Format' },
        { ext: 'hwp', name: 'Hanword Document' },
        { ext: 'dwf', name: 'Design Web Format' }
      ]
    };

    // ============================================
    // SEARCH ENGINES REGISTRY
    // ============================================
    const searchEngines = {
      'g:':          { name: 'Google',                       url: 'https://www.google.com/search?q=',                                                              domain: 'google.com' },
      'yt:':         { name: 'YouTube',                      url: 'https://www.youtube.com/results?search_query=',                                                  domain: 'youtube.com' },
      'brave:':      { name: 'Brave Search',                 url: 'https://search.brave.com/search?q=',                                                            domain: 'brave.com' },
      'ddg:':        { name: 'DuckDuckGo',                   url: 'https://duckduckgo.com/?q=',                                                                    domain: 'duckduckgo.com' },
      'yan:':        { name: 'Yandex',                       url: 'https://yandex.com/search/?text=',                                                              domain: 'yandex.com' },
      'bing:':       { name: 'Bing',                         url: 'https://www.bing.com/search?q=',                                                                domain: 'bing.com' },
      'bd:':         { name: 'Baidu',                        url: 'https://www.baidu.com/s?wd=',                                                                   domain: 'baidu.com' },
      'gplus:':      { name: 'Google Avancé',                url: 'https://www.google.com/advanced_search?q=',                                                     domain: 'google.com' },
      'wiki:':       { name: 'Wikipedia',                    url: 'https://wikipedia.org/w/index.php?search=',                                                     domain: 'wikipedia.org', plusEncoding: true },
      'bdbk:':       { name: 'Baidu Baike (wiki)',           url: 'https://baike.baidu.com/item/',                                                                 domain: 'baidu.com', favicon: 'https://www.google.com/s2/favicons?sz=32&domain=baike.baidu.com' },
      'grokw:':      { name: 'Grokipedia',                   url: 'https://grokipedia.com/search?q=',                                                             domain: 'grokipedia.com' },
      'ww:':         { name: 'WikiWand',                     url: 'https://www.wikiwand.com/en/search?q=',                                                        domain: 'wikiwand.com', plusEncoding: true },
      'gai:':        { name: 'Google AI Mode',               url: 'https://www.google.com/search?udm=50&q=',                                                       domain: 'google.com' },
      'scholar:':    { name: 'Google Scholar',               url: 'https://scholar.google.com/scholar?q=',                                                         domain: 'google.com' },
      'pubmed:':     { name: 'PubMed',                       url: 'https://pubmed.ncbi.nlm.nih.gov/?term=',                                                        domain: 'ncbi.nlm.nih.gov' },
      'arxiv:':      { name: 'arXiv',                        url: 'https://arxiv.org/search/?query=',                                                              domain: 'arxiv.org' },
      'gpat:':       { name: 'Google Patents',               url: 'https://patents.google.com/',                                                                   domain: 'patents.google.com', favicon: 'https://raw.githubusercontent.com/achma-learning/searchAIO/refs/heads/main/missing%20favicons/patents.google.com-favicon.ico' },
      'these2.0:':   { name: 'These2.0',                    url: 'https://thesefmpm.vercel.app/search?page=1&search=',                                            domain: 'thesefmpm.vercel.app' },
      'cismef-th:':  { name: 'CISMeF Thèses',               url: 'https://doccismef.chu-rouen.fr/dc/#env=thm&q=',                                                 domain: 'doccismef.chu-rouen.fr', favicon: 'https://raw.githubusercontent.com/achma-learning/searchAIO/refs/heads/main/missing%20favicons/www.cismef.org-favicon.ico' },
      'these-ma:':   { name: 'Toubkal',                     url: 'https://toubkal.imist.ma/search?query=',                                                        domain: 'toubkal.imist.ma' },
      'these-fr:':   { name: 'Theses.fr',                   url: 'https://theses.fr/resultats?filtres=%255BStatut%25253D%252522soutenue%252522~Statut%25253D%252522Accessibles%252520en%252520ligne%252522%255D&q=', domain: 'theses.fr' },
      'rgate:':      { name: 'ResearchGate',                 url: 'https://www.researchgate.net/search/publication?q=',                                           domain: 'researchgate.net' },
      'ndltd:':      { name: 'NDLTD',                        url: 'http://search.ndltd.org/search.php?q=',                                                        domain: 'ndltd.org' },
      'bdedu:':      { name: 'Baidu Academic (Xueshu)',      url: 'https://xueshu.baidu.com/ndscholar/browse/search?wd=',                                          domain: 'baidu.com', plusEncoding: true },
      'proinserm:':  { name: 'Pro Inserm',                   url: 'https://pro.inserm.fr/?s=',                                                                    domain: 'pro.inserm.fr', favicon: 'https://raw.githubusercontent.com/achma-learning/searchAIO/refs/heads/main/missing%20favicons/pro.inserm.fr-favicon.png' },
      'cismef:':     { name: 'CISMeF',                       url: 'https://doccismef.chu-rouen.fr/dc/#',                                                          domain: 'doccismef.chu-rouen.fr', favicon: 'https://raw.githubusercontent.com/achma-learning/searchAIO/refs/heads/main/missing%20favicons/www.cismef.org-favicon.ico' },
      'msps:':       { name: 'Ministère de la santé et de la Protection Sociale', url: 'https://www.google.com/search?q=site:sante.gov.ma ', directUrl: 'https://www.sante.gov.ma/SearchCenter/Pages/results.aspx?k=', domain: 'sante.gov.ma', favicon: 'https://raw.githubusercontent.com/achma-learning/searchAIO/refs/heads/main/missing%20favicons/www.sante.gov.ma-favicon.png' },
      // AMMPS — Agence Marocaine des Médicaments et des Produits de Santé
      'ammps:':      { name: 'AMMPS – Médicaments',           url: 'https://ammps.sante.gov.ma/recherche-medicaments?search=',                                     domain: 'ammps.sante.gov.ma', plusEncoding: true, favicon: 'https://ammps.sante.gov.ma/favicon.ico' },
      'ammps-lm:':   { name: 'AMMPS – Liste Médicaments',      url: 'https://ammps.sante.gov.ma/basesdedonnes/listes-medicaments?search=',                         domain: 'ammps.sante.gov.ma', plusEncoding: true, favicon: 'https://ammps.sante.gov.ma/favicon.ico' },
      'ammps-rmmg:': { name: 'AMMPS – RMMG',                   url: 'https://www.google.com/search?q=site:ammps.sante.gov.ma/callpages/RMMG+',                      domain: 'ammps.sante.gov.ma', plusEncoding: true, favicon: 'https://ammps.sante.gov.ma/favicon.ico' },
      'ammps-lvl:':  { name: 'AMMPS – Vaccins Libérés',        url: 'https://ammps.sante.gov.ma/basesdedonnes/liste-vaccin-libere?search=',                        domain: 'ammps.sante.gov.ma', plusEncoding: true, favicon: 'https://ammps.sante.gov.ma/favicon.ico' },
      'ammps-p:':    { name: 'AMMPS – Pharmacies',             url: 'https://ammps.sante.gov.ma/basesdedonnes/pharmacies?search=',                                  domain: 'ammps.sante.gov.ma', plusEncoding: true, favicon: 'https://ammps.sante.gov.ma/favicon.ico' },
      'ammps-gs:':   { name: 'AMMPS – site:AMMPS',             url: 'https://www.google.com/search?q=site:ammps.sante.gov.ma+',                                     domain: 'ammps.sante.gov.ma', plusEncoding: true, favicon: 'https://ammps.sante.gov.ma/favicon.ico' },
      'has:':        { name: 'HAS',                          url: 'https://www.has-sante.fr/jcms/fc_2875171/fr/resultat-de-recherche?text=',                      domain: 'has-sante.fr' },
      'vidal:':      { name: 'VIDAL',                        url: 'https://www.vidal.fr/recherche.html?query=',                                                   domain: 'vidal.fr' },
      'cismef-bp:':  { name: 'CISMeF Bonnes Pratiques',     isAlias: true, aliasFor: 'cismef:', filterValue: 'env=bp&q=' },
      'cismef-edu:': { name: 'CISMeF Éducation',            isAlias: true, aliasFor: 'cismef:', filterValue: 'env=unf3s&q=' },
      'cismef-edn:': { name: 'CISMeF ECN',                  isAlias: true, aliasFor: 'cismef:', filterValue: 'env=ecn&q=a&p=' },
      'cismef-pat:': { name: 'CISMeF Patients',             isAlias: true, aliasFor: 'cismef:', filterValue: 'env=pat&q=' },
      'lissa:':      { name: 'LISSA',                        url: 'https://www.lissa.fr/dc/#env=lissa&q=',                                                        domain: 'lissa.fr', favicon: 'https://raw.githubusercontent.com/achma-learning/searchAIO/refs/heads/main/missing%20favicons/www.lissa.fr-favicon.ico' },
      'anm:':        { name: 'Académie nationale de médecine', url: 'http://91.209.229.113/search?titre=',                                                        domain: '91.209.229.113' },
      'hetop:':      { name: 'HETOP',                        url: 'https://www.hetop.eu/hetop/fr/#oti=all&q=',                                                    domain: 'hetop.eu', plusEncoding: true },
      'nejm:':       { name: 'New England Journal of Medicine', url: 'https://www.nejm.org/search?q=',                                                            domain: 'nejm.org' },
      'rp:':         { name: 'Radiopaedia',                  url: 'https://radiopaedia.org/search?q=',                                                            domain: 'radiopaedia.org' },
      'utd:':        { name: 'UpToDate',                     url: 'https://www.uptodate.com/contents/search?search=',                                             domain: 'uptodate.com' },
      'coch:':       { name: 'Cochrane Library',             url: 'https://www.cochranelibrary.com/search?q=',                                                    domain: 'cochranelibrary.com' },
      'medscape:':   { name: 'Medscape',                     url: 'https://search.medscape.com/search/fr/',                                                       domain: 'medscape.com' },
      'openmd:':     { name: 'OpenMD',                       url: 'https://openmd.com/search?q=',                                                                 domain: 'openmd.com' },
      'mesh:':       { name: 'MeSH Browser',                 url: 'https://meshb.nlm.nih.gov/search?searchInField=allTerms&searchString=',                       domain: 'nlm.nih.gov' },
      'dd:':         { name: 'Diseases Database',            url: 'http://www.diseasesdatabase.com/item_choice.asp?strUserInput=',                                domain: 'diseasesdatabase.com' },
      'webmd:':      { name: 'WebMD',                        url: 'https://www.webmd.com/search?query=',                                                          domain: 'webmd.com' },
      'nih:':        { name: 'NIH',                          url: 'https://search.usa.gov/search?utf8=%E2%9C%93&affiliate=nih&query=',                            domain: 'nih.gov', favicon: 'https://www.google.com/s2/favicons?sz=32&domain=nlm.nih.gov' },
      'drugs:':      { name: 'Drugs.com',                    url: 'https://www.drugs.com/search.php?searchterm=',                                                 domain: 'drugs.com' },
      'cdc:':        { name: 'CDC',                          url: 'https://search.cdc.gov/search/?query=',                                                        domain: 'cdc.gov' },
      'wolf:':       { name: 'Wolfram Alpha',                url: 'https://www.wolframalpha.com/input?i=',                                                        domain: 'wolframalpha.com' },
      'chatgpt:':    { name: 'ChatGPT',                       url: 'https://chatgpt.com/?prompt=',                                                                 domain: 'chatgpt.com', plusEncoding: true },
      'claude:':     { name: 'Claude AI 📋',                 url: 'https://claude.ai/new?q=',                                                                     domain: 'claude.ai', promptBased: true },
      'gemini:':     { name: 'Gemini 📋',                    url: 'https://gemini.google.com/app?q=',                                                             domain: 'gemini.google.com', promptBased: true },
      'perplexity:': { name: 'Perplexity',                   url: 'https://www.perplexity.ai/search?q=',                                                          domain: 'perplexity.ai' },
      'copilot:':    { name: 'Copilot 📋',                   url: 'https://copilot.microsoft.com/?q=',                                                            domain: 'microsoft.com', promptBased: true },
      'cbd:':        { name: 'Chat Baidu',                   url: 'https://chat.baidu.com/search?word=',                                                          domain: 'baidu.com', plusEncoding: true },
      'ernie:':      { name: 'Baidu AI 📋',                  url: 'https://ernie.baidu.com/',                                                                     domain: 'baidu.com', promptBased: true },
      'duckai:':     { name: 'Duck.ai',                      url: 'https://duck.ai/chat?q=',                                                                      domain: 'duckduckgo.com', plusEncoding: true }
    };

    // ============================================
    // !BANG MAP & DETECTION
    // ============================================

    const BANG_MAP = {
      // 🌐 General
      '!g': 'g:',         '!google': 'g:',
      '!yt': 'yt:',       '!youtube': 'yt:',
      '!br': 'brave:',    '!brave': 'brave:',
      '!ddg': 'ddg:',     '!duck': 'ddg:',
      '!yan': 'yan:',     '!yandex': 'yan:',
      '!bing': 'bing:',
      '!bd': 'bd:',       '!baidu': 'bd:',
      '!gai': 'gai:',     '!gaimode': 'gai:',
      '!gplus': 'gplus:', '!gadv': 'gplus:',
      '!wiki': 'wiki:',   '!wp': 'wiki:',    '!wikipedia': 'wiki:',
      '!bdbk': 'bdbk:',  '!baike': 'bdbk:',
      '!grokw': 'grokw:', '!grok': 'grokw:',
      '!ww': 'ww:',       '!wikiwand': 'ww:',
      // 🎓 Academic
      '!sc': 'scholar:',  '!scholar': 'scholar:',
      '!pm': 'pubmed:',   '!pubmed': 'pubmed:',
      '!ax': 'arxiv:',    '!arxiv': 'arxiv:',
      '!pat': 'gpat:',    '!gpat': 'gpat:',
      '!rg': 'rgate:',    '!rgate': 'rgate:',
      '!ndltd': 'ndltd:',
      '!bdedu': 'bdedu:', '!xueshu': 'bdedu:',
      '!t2': 'these2.0:', '!these': 'these-fr:',
      '!toubkal': 'these-ma:',
      // ⚕️ Medical / French
      '!csf': 'cismef:',  '!cismef': 'cismef:',
      '!has': 'has:',
      '!ammps': 'ammps:',  '!ammps-lm': 'ammps-lm:',
      '!ammps-rmmg': 'ammps-rmmg:', '!ammps-lvl': 'ammps-lvl:',
      '!ammps-p': 'ammps-p:', '!ammps-gs': 'ammps-gs:',
      '!vid': 'vidal:',   '!vidal': 'vidal:',
      '!lissa': 'lissa:', '!anm': 'anm:',
      '!hetop': 'hetop:', '!mesh': 'mesh:',
      // ⚕️ Medical / International
      '!utd': 'utd:',     '!uptodate': 'utd:',
      '!coch': 'coch:',   '!cochrane': 'coch:',
      '!ms': 'medscape:', '!medscape': 'medscape:',
      '!webmd': 'webmd:',
      '!nih': 'nih:',
      '!cdc': 'cdc:',
      '!rp': 'rp:',       '!radio': 'rp:',   '!radiopaedia': 'rp:',
      '!dd': 'dd:',       '!disease': 'dd:',
      '!drugs': 'drugs:',
      '!nejm': 'nejm:',   '!nej': 'nejm:',
      '!omd': 'openmd:',
      // 🤖 AI / Advanced
      '!gpt': 'chatgpt:', '!chatgpt': 'chatgpt:',
      '!cl': 'claude:',   '!claude': 'claude:',
      '!gem': 'gemini:',  '!gemini': 'gemini:',
      '!px': 'perplexity:', '!perplexity': 'perplexity:',
      '!cop': 'copilot:', '!copilot': 'copilot:',
      '!wolf': 'wolf:',   '!wolfram': 'wolf:',
      '!dai': 'duckai:',  '!duckai': 'duckai:',
      '!ernie': 'ernie:', '!bai': 'ernie:',
    };

    /**
     * Detect a !bang token anywhere in `value`.
     * Returns { prefix, token, cleanQuery } or null.
     * Tries matches from right to left so end-of-query bangs are preferred.
     */
    function detectBang(value) {
      const tokens = [...value.matchAll(/(?:^|\s)(![\w-]+)(?=\s|$)/g)];
      for (let i = tokens.length - 1; i >= 0; i--) {
        const token = tokens[i][1].toLowerCase();
        const prefix = BANG_MAP[token];
        if (prefix) {
          // Remove the matched bang token (and any surrounding extra spaces)
          const cleanQuery = value
            .replace(new RegExp('(?:^|\\s)' + token.replace('!', '\\!') + '(?=\\s|$)', 'i'), ' ')
            .replace(/\s+/g, ' ')
            .trim();
          return { prefix, token, cleanQuery };
        }
      }
      return null;
    }

    const bangIndicator    = document.getElementById('bang-indicator');
    const bangEngineLabel  = bangIndicator.querySelector('.bang-engine');
    const BAIDU_PREFIXES  = ['bd:', 'bdedu:', 'cbd:', 'bdbk:'];
    const AMMPS_PREFIXES  = ['ammps:', 'ammps-lm:', 'ammps-rmmg:', 'ammps-lvl:', 'ammps-p:', 'ammps-gs:'];

    // ============================================
    // DOM REFERENCES
    // ============================================
    const searchInput            = document.getElementById('searchInput');
    const searchForm             = document.getElementById('searchForm');
    const searchSource           = document.getElementById('searchSource');
    const wikiToggleBtn          = document.getElementById('wikiToggleBtn');
    const wikiContent            = document.getElementById('wikiContent');
    const keepWikiOpenCheckbox   = document.getElementById('keepWikiOpenCheckbox');
    const filetypesBtn           = document.getElementById('filetypesBtn');
    const filetypesPopup         = document.getElementById('filetypesPopup');
    const siteBtn                = document.getElementById('siteBtn');
    const popupOverlay           = document.getElementById('popupOverlay');
    const closeFiletypes         = document.getElementById('closeFiletypes');
    const bangsBtn               = document.getElementById('bangsBtn');
    const youtubeFilters         = document.getElementById('youtubeFilters');
    const googleOperatorFilters  = document.getElementById('googleOperatorFilters');
    const cismefFilters          = document.getElementById('cismefFilters');
    const ammpsFilters           = document.getElementById('ammpsFilters');
    const googleWikiBtn          = document.getElementById('googleWikiBtn');
    const googleWikiPopup        = document.getElementById('googleWikiPopup');
    const closeGoogleWikiBtn     = document.getElementById('closeGoogleWikiBtn');
    const keepGoogleWikiOpenCheckbox = document.getElementById('keepGoogleWikiOpenCheckbox');
    const bingOperatorFilters    = document.getElementById('bingOperatorFilters');
    const bingWikiBtn            = document.getElementById('bingWikiBtn');
    const bingWikiPopup          = document.getElementById('bingWikiPopup');
    const closeBingWikiBtn       = document.getElementById('closeBingWikiBtn');
    const keepBingWikiOpenCheckbox = document.getElementById('keepBingWikiOpenCheckbox');
    const keyboardShortcutsBtn   = document.getElementById('keyboardShortcutsBtn');
    const keyboardShortcutsPopup = document.getElementById('keyboardShortcutsPopup');
    const duckBangBtn            = document.getElementById('duckBangBtn');

    // Yandex
    const yandexTranslationBox  = document.getElementById('yandexTranslationBox');
    const yandexSourceLang      = document.getElementById('yandexSourceLang');
    const yandexSourceText      = document.getElementById('yandexSourceText');
    const yandexTargetText      = document.getElementById('yandexTargetText');
    const yandexOpenBtn         = document.getElementById('yandexOpenBtn');
    const yandexInsertBtn       = document.getElementById('yandexInsertBtn');
    const yandexCopyBtn         = document.getElementById('yandexCopyBtn');
    const yandexTranslateSearchBtn = document.getElementById('yandexTranslateSearchBtn');
    const yandexTranslateStatus = document.getElementById('yandexTranslateStatus');

    // Baidu
    const baiduTranslationBox   = document.getElementById('baiduTranslationBox');
    const baiduSourceLang       = document.getElementById('baiduSourceLang');
    const baiduSourceText       = document.getElementById('baiduSourceText');
    const baiduTargetText       = document.getElementById('baiduTargetText');
    const baiduOpenBtn          = document.getElementById('baiduOpenBtn');
    const baiduCopyBtn          = document.getElementById('baiduCopyBtn');
    const baiduInsertBtn        = document.getElementById('baiduInsertBtn');
    const baiduTranslateSearchBtn = document.getElementById('baiduTranslateSearchBtn');
    const baiduTranslateStatus  = document.getElementById('baiduTranslateStatus');

    // ============================================
    // FAVICONS
    // ============================================
    function addFaviconsToSearchEngines() {
      document.querySelectorAll('input[name="searchEngine"]').forEach(radio => {
        const prefix = radio.value;
        const engine = searchEngines[prefix];
        if (engine) {
          let faviconUrl = engine.favicon
            ? engine.favicon
            : engine.domain
              ? `https://www.google.com/s2/favicons?sz=32&domain=${engine.domain}`
              : null;
          if (faviconUrl) {
            const img = document.createElement('img');
            img.src = faviconUrl;
            img.alt = `${engine.name} Favicon`;
            img.classList.add('favicon-icon');
            radio.parentNode.insertBefore(img, radio.nextSibling);
          }
        }
      });
    }

    // ============================================
    // KEYBOARD SHORTCUTS POPUP
    // ============================================
    function openShortcutsPopup() {
      keyboardShortcutsPopup.classList.add('show');
      popupOverlay.classList.add('show');
    }

    function closeShortcutsPopup() {
      keyboardShortcutsPopup.classList.remove('show');
      if (!filetypesPopup.classList.contains('show') &&
          !googleWikiPopup.classList.contains('show') &&
          !bingWikiPopup.classList.contains('show')) {
        popupOverlay.classList.remove('show');
      }
    }

    keyboardShortcutsBtn.addEventListener('click', openShortcutsPopup);
    document.getElementById('cheat-close-dot').addEventListener('click', closeShortcutsPopup);

    // ============================================
    // TRANSLATION ENGINE (Google unofficial primary, MyMemory fallback)
    // ============================================

    /**
     * Map internal lang codes → Google Translate lang codes.
     * Google uses "zh-CN" for Simplified Chinese.
     */
    function toGoogleLang(lang) {
      if (lang === 'zh') return 'zh-CN';
      if (lang === 'auto') return 'auto';
      return lang;
    }

    /**
     * Translate via Google's unofficial endpoint.
     * Same engine as translate.google.com — excellent Chinese & Russian quality.
     * Note: unofficial, can break at any time.
     */
    async function translateWithGoogle(text, sourceLang, targetLang) {
      if (!text.trim()) return '';
      const sl = toGoogleLang(sourceLang);
      const tl = toGoogleLang(targetLang);
      const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sl}&tl=${tl}&dt=t&q=${encodeURIComponent(text)}`;
      const response = await fetch(url);
      if (!response.ok) throw new Error(`Google Translate HTTP ${response.status}`);
      const data = await response.json();
      // data[0] is an array of [translated, original, ...] pairs
      return data[0].map(item => item[0]).filter(Boolean).join('');
    }

    /**
     * Translate via LibreTranslate (open-source, public instance).
     * More consistent than MyMemory, decent Chinese & Russian quality.
     * Used as 2nd fallback when Google's unofficial endpoint fails.
     */
    async function translateWithLibre(text, sourceLang, targetLang) {
      if (!text.trim()) return '';
      // LibreTranslate uses "zh" for Chinese and doesn't support "zh-CN"
      const sl = (sourceLang === 'zh-CN' || sourceLang === 'auto') ? 'zh' : sourceLang;
      const tl = targetLang === 'zh-CN' ? 'zh' : targetLang;
      const response = await fetch('https://libretranslate.com/translate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ q: text, source: sl === 'auto' ? 'en' : sl, target: tl, format: 'text' })
      });
      if (!response.ok) throw new Error(`LibreTranslate HTTP ${response.status}`);
      const data = await response.json();
      if (data.translatedText) return data.translatedText;
      throw new Error(data.error || 'LibreTranslate returned no text');
    }

    /**
     * Translate via MyMemory API (free, limited).
     * Used as last-resort fallback when both Google and LibreTranslate fail.
     */
    async function translateWithMyMemory(text, sourceLang, targetLang) {
      if (!text.trim()) return '';
      const sl = (sourceLang === 'auto' || sourceLang === 'zh-CN') ? 'zh' : sourceLang;
      const tl = targetLang === 'zh-CN' ? 'zh' : targetLang;
      const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${sl}|${tl}`;
      const response = await fetch(url);
      const data = await response.json();
      if (data.responseStatus === 200) return data.responseData.translatedText;
      throw new Error(data.responseDetails || 'MyMemory translation failed');
    }

    /**
     * Main translation function.
     * Chain: Google (unofficial) → LibreTranslate → MyMemory
     * Each step only fires if the previous one throws.
     */
    async function translateText(text, sourceLang, targetLang) {
      try {
        return await translateWithGoogle(text, sourceLang, targetLang);
      } catch (googleErr) {
        console.warn('[Translation] Google API failed, trying LibreTranslate:', googleErr.message);
        try {
          return await translateWithLibre(text, sourceLang, targetLang);
        } catch (libreErr) {
          console.warn('[Translation] LibreTranslate failed, falling back to MyMemory:', libreErr.message);
          return await translateWithMyMemory(text, sourceLang, targetLang);
        }
      }
    }

    /**
     * Parse Baidu lang-pair dropdown value ("en2zh", "auto2zh", etc.)
     * and return { sl, tl } for the translation API.
     */
    function parseBaiduLangPair(value) {
      const [from, to] = value.split('2');
      return { sl: from, tl: to === 'zh' ? 'zh-CN' : to };
    }

    // ============================================
    // YANDEX TRANSLATION (Google unofficial primary, MyMemory fallback, 500 ms debounce)
    // ============================================

    /**
     * Build the Yandex Translate URL.
     * Format: https://translate.yandex.com/en/translator/English-Russian
     * With optional ?text=… when there is source text.
     */
    const YANDEX_LANG_NAMES = {
      en: 'English', fr: 'French', de: 'German', es: 'Spanish',
      ar: 'Arabic',  zh: 'Chinese', it: 'Italian', pt: 'Portuguese'
    };

    function buildYandexTranslateUrl() {
      const src     = yandexSourceLang.value;
      const text    = yandexSourceText.value.trim();
      const srcName = YANDEX_LANG_NAMES[src] || 'English';
      const base    = `https://translate.yandex.com/en/translator/${srcName}-Russian`;
      return text ? `${base}?text=${encodeURIComponent(text)}` : base;
    }

    function setYandexStatus(msg, type = '') {
      yandexTranslateStatus.textContent = msg;
      yandexTranslateStatus.className   = type;
    }

    let yandexTranslationTimeout;

    function scheduleYandexTranslation() {
      clearTimeout(yandexTranslationTimeout);
      const textToTranslate = yandexSourceText.value;
      if (!textToTranslate.trim()) {
        yandexTargetText.value = '';
        setYandexStatus('');
        return;
      }
      setYandexStatus('Translating…', 'loading');
      yandexTranslationTimeout = setTimeout(async () => {
        try {
          const translated = await translateText(textToTranslate, yandexSourceLang.value, 'ru');
          yandexTargetText.value = translated;
          setYandexStatus('✓ Translation complete', 'success');
          setTimeout(() => { if (yandexTranslateStatus.textContent.includes('complete')) setYandexStatus(''); }, 2500);
        } catch {
          yandexTargetText.value = '';
          setYandexStatus('✗ All translation APIs failed. Use "🔗 Open in Yandex Translate" as backup.', 'error');
        }
      }, 500);
    }

    yandexSourceText.addEventListener('input',  scheduleYandexTranslation);
    yandexSourceLang.addEventListener('change', scheduleYandexTranslation);

    yandexOpenBtn.addEventListener('click', () => {
      window.open(buildYandexTranslateUrl(), '_blank');
    });

    yandexCopyBtn.addEventListener('click', () => {
      const text = yandexTargetText.value;
      if (!text.trim()) { setYandexStatus('Nothing to copy.', 'error'); return; }
      navigator.clipboard.writeText(text).then(() => {
        setYandexStatus('✓ Copied to clipboard!', 'success');
        setTimeout(() => setYandexStatus(''), 2000);
      });
    });

    yandexInsertBtn.addEventListener('click', () => {
      const text = yandexTargetText.value;
      if (!text.trim()) { setYandexStatus('Nothing to insert.', 'error'); return; }
      const start = searchInput.selectionStart;
      const end   = searchInput.selectionEnd;
      searchInput.value = searchInput.value.substring(0, start) + text + searchInput.value.substring(end);
      searchInput.selectionStart = searchInput.selectionEnd = start + text.length;
      searchInput.focus();
      setYandexStatus('✓ Inserted into search bar!', 'success');
      setTimeout(() => setYandexStatus(''), 2000);
    });

    // ============================================
    // 🇨🇳 BAIDU / CHINESE TRANSLATION
    // (Google unofficial primary, 500 ms debounce; Baidu Fanyi as backup button)
    // ============================================

    /**
     * Build the Baidu Fanyi URL (used for the backup "Open in Baidu Fanyi" button).
     * Format: https://fanyi.baidu.com/#FROM/TO/ENCODED_TEXT
     * The dropdown value uses "2" as separator: e.g. "en2zh" → from=en, to=zh
     */
    function buildBaiduUrl(text, langPairValue) {
      const [from, to] = langPairValue.split('2');
      const encoded = text.trim() ? encodeURIComponent(text.trim()) : '';
      return `https://fanyi.baidu.com/#${from}/${to}/${encoded}`;
    }

    function setBaiduStatus(msg, color, durationMs = 3000) {
      baiduTranslateStatus.textContent = msg;
      baiduTranslateStatus.style.color = color;
      if (durationMs) {
        setTimeout(() => {
          if (baiduTranslateStatus.textContent === msg) {
            baiduTranslateStatus.textContent = '';
          }
        }, durationMs);
      }
    }

    let baiduTranslationTimeout;

    function scheduleBaiduTranslation() {
      clearTimeout(baiduTranslationTimeout);
      const textToTranslate = baiduSourceText.value;
      if (!textToTranslate.trim()) {
        baiduTargetText.value = '';
        setBaiduStatus('', '');
        return;
      }
      setBaiduStatus('Translating…', '#ff9800', 0);
      baiduTranslationTimeout = setTimeout(async () => {
        try {
          const { sl, tl } = parseBaiduLangPair(baiduSourceLang.value);
          const translated = await translateText(textToTranslate, sl, tl);
          baiduTargetText.value = translated;
          setBaiduStatus('✓ Translation complete', '#4caf50');
          setTimeout(() => {
            if (baiduTranslateStatus.textContent.includes('complete')) setBaiduStatus('', '');
          }, 2500);
        } catch {
          baiduTargetText.value = '';
          setBaiduStatus('✗ All translation APIs failed. Use "🔗 Open in Baidu Fanyi" as backup.', '#f44336', 0);
        }
      }, 500);
    }

    baiduSourceText.addEventListener('input',  scheduleBaiduTranslation);
    baiduSourceLang.addEventListener('change', scheduleBaiduTranslation);

    // Backup button — open Baidu Fanyi directly
    baiduOpenBtn.addEventListener('click', () => {
      const url = buildBaiduUrl(baiduSourceText.value, baiduSourceLang.value);
      window.open(url, '_blank', 'noopener,noreferrer');
      setBaiduStatus('✅ Opened Baidu Fanyi in a new tab.', '#28a745', 4000);
    });

    // Copy translated text to clipboard
    baiduCopyBtn.addEventListener('click', () => {
      const text = baiduTargetText.value.trim();
      if (!text) {
        setBaiduStatus('⚠️ No translation to copy yet.', '#e53935');
        return;
      }
      navigator.clipboard.writeText(text)
        .then(()  => setBaiduStatus('✅ Copied to clipboard!', '#28a745'))
        .catch(()  => setBaiduStatus('❌ Copy failed — please copy manually.', '#e53935', 0));
    });

    // Insert translated text into the main search bar
    baiduInsertBtn.addEventListener('click', () => {
      const text = baiduTargetText.value.trim();
      if (!text) {
        setBaiduStatus('⚠️ No translation to insert yet.', '#e53935');
        return;
      }
      const start = searchInput.selectionStart;
      const end   = searchInput.selectionEnd;
      searchInput.value = searchInput.value.substring(0, start) + text + searchInput.value.substring(end);
      searchInput.selectionStart = searchInput.selectionEnd = start + text.length;
      searchInput.focus();
      setBaiduStatus('✅ Inserted into search bar!', '#28a745');
    });

    // ============================================
    // 🔄 TRANSLATE SEARCH BAR  (Alt+V)
    // Reads the current query from the search input, translates it to the
    // target language of the active engine, and replaces the query in-place.
    // Works for: yan: → Russian   |   BAIDU_PREFIXES → Chinese
    // ============================================

    /**
     * Get the target language for the current engine.
     * Returns 'ru' for Yandex, resolved zh-target for Baidu engines, null otherwise.
     */
    function getTranslateSearchTarget() {
      const activePrefix = (() => {
        let best = '';
        const val = searchInput.value.trim();
        for (const k of Object.keys(searchEngines)) {
          if (val.startsWith(k) && k.length > best.length) best = k;
        }
        if (!best) {
          const r = document.querySelector('input[name="searchEngine"]:checked');
          if (r) best = r.value;
        }
        return best;
      })();
      if (activePrefix === 'yan:') return { tl: 'ru', label: 'Russian', setStatus: setYandexStatus };
      if (BAIDU_PREFIXES.includes(activePrefix)) {
        const { tl } = parseBaiduLangPair(baiduSourceLang.value);
        return { tl, label: 'Chinese', setStatus: (m, c) => setBaiduStatus(m, c || '#1565c0') };
      }
      return null;
    }

    async function translateSearchBar() {
      const query = searchInput.value.trim();
      if (!query) return;
      const target = getTranslateSearchTarget();
      if (!target) return;

      const { tl, label, setStatus } = target;
      // Determine source lang: for Yandex use the source select; for Baidu parse the pair
      const sl = (tl === 'ru')
        ? (yandexSourceLang ? yandexSourceLang.value : 'en')
        : parseBaiduLangPair(baiduSourceLang.value).sl;

      setStatus(`🔄 Translating search bar to ${label}…`, '#1565c0');
      searchInput.value = '';          // clear bar immediately (like cut)
      searchInput.disabled = true;

      try {
        const translated = await translateText(query, sl, tl);
        searchInput.value    = translated;
        searchInput.disabled = false;
        searchInput.focus();
        searchInput.select();
        setStatus(`✅ Search bar translated to ${label}!`, '#28a745');
        setTimeout(() => setStatus(''), 2500);
      } catch {
        searchInput.value    = query;  // restore original on failure
        searchInput.disabled = false;
        searchInput.focus();
        setStatus('❌ Translation failed — original query restored.', '#e53935');
      }
      updateSearchSource();
    }

    yandexTranslateSearchBtn.addEventListener('click', translateSearchBar);
    baiduTranslateSearchBtn.addEventListener('click', translateSearchBar);

    // ============================================
    // UPDATE SEARCH SOURCE (central sync hub)
    // ============================================
    function updateSearchSource() {
      let source = 'Entrez une requête pour afficher la source';
      let color  = '#555';
      const value = searchInput.value.trim();
      const searchPrefixFavicon = document.getElementById('search-prefix-favicon');

      let effectivePrefix = '';
      let effectiveEngine = null;

      // 1. Check for prefix in input — longest match wins (so "cismef-bp:" beats "cismef:")
      for (const key of Object.keys(searchEngines)) {
        if (value.startsWith(key) && key.length > effectivePrefix.length) effectivePrefix = key;
      }

      // 2. Fallback to selected radio
      if (!effectivePrefix) {
        const selectedRadio = document.querySelector('input[name="searchEngine"]:checked');
        if (selectedRadio) effectivePrefix = selectedRadio.value;
      }

      if (effectivePrefix) effectiveEngine = searchEngines[effectivePrefix];

      // 3. Handle aliases
      let sourceName = effectiveEngine ? effectiveEngine.name : null;
      if (effectiveEngine && effectiveEngine.isAlias) {
        const originalFilterValue = effectiveEngine.filterValue;
        sourceName = effectiveEngine.name;
        effectivePrefix = effectiveEngine.aliasFor;
        effectiveEngine = searchEngines[effectivePrefix];
        if (originalFilterValue) {
          const filterRadio = document.querySelector(`input[name="cismef_scope"][value="${originalFilterValue}"]`);
          if (filterRadio) filterRadio.checked = true;
        }
      }

      // 3b. AMMPS: when prefix is base 'ammps:', reflect the active sub-radio in sourceName
      if (effectivePrefix === 'ammps:') {
        const activeSub = document.querySelector('input[name="ammps_scope"]:checked');
        if (activeSub && activeSub.value !== 'ammps:') {
          const subEngine = searchEngines[activeSub.value];
          if (subEngine) sourceName = subEngine.name;
        }
      }
      // 4. Update display
      if (effectiveEngine) {
        const categoryEmojis = { general: '🌐', academic: '🎓', medical: '⚕️', ai: '🤖' };
        const categoryMap = {
          general:  ['g:', 'yt:', 'brave:', 'ddg:', 'yan:', 'bing:', 'bd:', 'gplus:', 'wiki:', 'bdbk:', 'grokw:', 'ww:'],
          academic: ['scholar:', 'pubmed:', 'arxiv:', 'gpat:', 'these2.0:', 'cismef-th:', 'these-ma:', 'these-fr:', 'rgate:', 'ndltd:', 'proinserm:', 'bdedu:'],
          medical:  ['cismef:', 'msps:', 'ammps:', 'ammps-lm:', 'ammps-rmmg:', 'ammps-lvl:', 'ammps-p:', 'ammps-gs:', 'has:', 'vidal:', 'mesh:', 'lissa:', 'anm:', 'hetop:', 'nejm:', 'rp:', 'utd:', 'coch:', 'medscape:', 'openmd:', 'dd:', 'webmd:', 'nih:', 'drugs:', 'cdc:', 'cismef-bp:', 'cismef-edu:', 'cismef-edn:', 'cismef-pat:'],
          ai:       ['wolf:', 'chatgpt:', 'claude:', 'gemini:', 'gai:', 'perplexity:', 'copilot:', 'cbd:', 'ernie:', 'duckai:']
        };
        let engineCategory = 'general';
        for (const [cat, prefixes] of Object.entries(categoryMap)) {
          if (prefixes.includes(effectivePrefix)) { engineCategory = cat; break; }
        }
        source = categoryEmojis[engineCategory] + ' ' + sourceName;
        color  = '#28a745';

        // Favicon swap
        let faviconUrl = effectiveEngine.favicon
          ? effectiveEngine.favicon
          : effectiveEngine.domain
            ? `https://www.google.com/s2/favicons?sz=32&domain=${effectiveEngine.domain}`
            : null;

        if (faviconUrl && faviconUrl !== searchPrefixFavicon.src) {
          searchPrefixFavicon.classList.remove('swapping');
          void searchPrefixFavicon.offsetWidth;
          searchPrefixFavicon.src   = faviconUrl;
          searchPrefixFavicon.alt   = sourceName;
          searchPrefixFavicon.title = sourceName;
          searchPrefixFavicon.classList.add('swapping');
        }

        // Sync radio buttons
        document.querySelectorAll('input[name="searchEngine"]').forEach(radio => {
          const match = radio.value === effectivePrefix;
          if (radio.checked !== match) radio.checked = match;
          radio.parentElement.classList.toggle('selected', match);
        });
      } else {
        source = 'Entrez une requête pour afficher la source';
        color  = '#555';
        if (!searchPrefixFavicon.src.includes('google.com')) {
          searchPrefixFavicon.classList.remove('swapping');
          void searchPrefixFavicon.offsetWidth;
          searchPrefixFavicon.src   = 'https://www.google.com/s2/favicons?sz=64&domain=google.com';
          searchPrefixFavicon.alt   = 'Google';
          searchPrefixFavicon.title = 'Google (défaut)';
          searchPrefixFavicon.classList.add('swapping');
        }
      }

      // ── Toggle filter panels ──────────────────────────────────────────────

      // YouTube
      youtubeFilters.style.display = (effectivePrefix === 'yt:') ? 'grid' : 'none';

      // Google operators
      const isGoogle = (effectivePrefix === 'g:');
      googleOperatorFilters.style.display = isGoogle ? 'grid' : 'none';
      filetypesBtn.style.display          = isGoogle ? 'inline-block' : 'none';
      googleWikiBtn.style.display         = isGoogle ? 'inline-block' : 'none';

      // Bing operators
      const isBing = (effectivePrefix === 'bing:');
      bingOperatorFilters.style.display = isBing ? 'grid' : 'none';
      bingWikiBtn.style.display         = isBing ? 'inline-block' : 'none';

      // DuckDuckGo !bang
      duckBangBtn.style.display = (effectivePrefix === 'ddg:') ? 'inline-block' : 'none';

      // CISMeF — effectivePrefix may be 'cismef:' or an alias like 'cismef-bp:' (before alias resolution)
      // We need the original typed prefix to know which sub-radio to check
      const cismefPrefixes = ['cismef:', 'cismef-bp:', 'cismef-edu:', 'cismef-edn:', 'cismef-pat:', 'cismef-th:'];
      const originalTypedCismef = Object.keys(searchEngines).reduce((best, k) =>
        value.startsWith(k) && k.startsWith('cismef') && k.length > best.length ? k : best, '');
      if (effectivePrefix === 'cismef:' || cismefPrefixes.includes(originalTypedCismef)) {
        cismefFilters.style.display = 'grid';
        // Sync sub-radio from the originally-typed cismef alias
        const aliasEngine = originalTypedCismef ? searchEngines[originalTypedCismef] : null;
        if (aliasEngine && aliasEngine.isAlias && aliasEngine.filterValue) {
          const filterRadio = document.querySelector(`input[name="cismef_scope"][value="${aliasEngine.filterValue}"]`);
          if (filterRadio) filterRadio.checked = true;
        }
      } else {
        cismefFilters.style.display = 'none';
      }

      // AMMPS sub-radio sync — effectivePrefix may now be 'ammps-lm:' etc. directly
      // Also resolve when base 'ammps:' radio is active
      const ammpsTypedPrefix = AMMPS_PREFIXES.includes(effectivePrefix) ? effectivePrefix : '';
      if (AMMPS_PREFIXES.includes(effectivePrefix)) {
        ammpsFilters.style.display = 'grid';
        // Sync sub-radio if a specific sub-prefix was typed (not the base ammps:)
        if (effectivePrefix !== 'ammps:') {
          const subRadio = document.querySelector(`input[name="ammps_scope"][value="${effectivePrefix}"]`);
          if (subRadio) subRadio.checked = true;
        }
      } else {
        ammpsFilters.style.display = 'none';
      }

      // Also check sub-radio to resolve site: engines
      const resolvedAmmps = ammpsTypedPrefix !== 'ammps:' && ammpsTypedPrefix
        ? ammpsTypedPrefix
        : (AMMPS_PREFIXES.includes(effectivePrefix) ? (() => {
            const s = document.querySelector('input[name="ammps_scope"]:checked');
            return s ? s.value : 'ammps:';
          })() : '');

      // Site: engines — auto-activate siteBtn
      const SITE_SEARCH_PREFIXES = ['ammps-rmmg:', 'ammps-gs:', 'msps:'];
      const isSiteEngine = SITE_SEARCH_PREFIXES.includes(effectivePrefix) || SITE_SEARCH_PREFIXES.includes(resolvedAmmps);
      if (isSiteEngine) {
        siteBtn.classList.add('active');
        siteBtn.setAttribute('aria-pressed', 'true');
      } else if (!['g:', 'bing:'].includes(effectivePrefix)) {
        if (siteBtn.dataset.autoActive === 'true') {
          siteBtn.classList.remove('active');
          siteBtn.setAttribute('aria-pressed', 'false');
        }
      }
      siteBtn.dataset.autoActive = isSiteEngine ? 'true' : 'false';

      // Yandex translation box
      const isYandex         = (effectivePrefix === 'yan:');
      const yandexBoxVisible = yandexTranslationBox.style.display !== 'none';
      yandexTranslationBox.style.display = isYandex ? 'grid' : 'none';
      if (isYandex && !yandexBoxVisible) {
        yandexSourceText.value = '';
        yandexSourceText.focus();
        scheduleYandexTranslation();
      } else if (!isYandex && yandexBoxVisible) {
        yandexSourceText.value      = '';
        yandexTargetText.value      = '';
        yandexTranslateStatus.textContent = '';
        yandexTranslateStatus.className   = '';
      }

      // ── ✅ Baidu Fanyi translation box ─────────────────────────────────────
      const isBaidu         = BAIDU_PREFIXES.includes(effectivePrefix);
      const baiduBoxVisible = baiduTranslationBox.style.display !== 'none';
      baiduTranslationBox.style.display = isBaidu ? 'block' : 'none';
      if (isBaidu && !baiduBoxVisible) {
        // Just switched TO a Baidu engine: clear and focus
        baiduSourceText.value            = '';
        baiduTargetText.value            = '';
        baiduTranslateStatus.textContent = '';
        baiduTranslateStatus.style.color = '';
        // bdbk: is a Chinese encyclopedia — default to English → Chinese
        if (effectivePrefix === 'bdbk:') baiduSourceLang.value = 'en2zh';
        setTimeout(() => baiduSourceText.focus(), 50);
      } else if (!isBaidu && baiduBoxVisible) {
        // Just switched AWAY: clean up
        baiduSourceText.value            = '';
        baiduTargetText.value            = '';
        baiduTranslateStatus.textContent = '';
        baiduTranslateStatus.style.color = '';
      }

      searchSource.textContent = source;
      searchSource.style.color = color;
    }

    // ============================================
    // RADIO BUTTON CHANGE
    // ============================================
    document.querySelectorAll('input[name="searchEngine"]').forEach(radio => {
      radio.addEventListener('change', function () {
        document.querySelectorAll('input[name="searchEngine"]').forEach(r => r.parentElement.classList.remove('selected'));
        radio.parentElement.classList.add('selected');
        let val = searchInput.value.trim();
        let bestKey = '';
        for (const key of Object.keys(searchEngines)) {
          if (val.startsWith(key) && key.length > bestKey.length) bestKey = key;
        }
        if (bestKey) val = val.substring(bestKey.length).trim();
        searchInput.value = val;
        updateSearchSource();
        searchInput.focus();
      });
    });

    // AMMPS sub-radio change → bidirectional sync
    // Clicking a sub-radio selects the ammps: main engine AND updates the source bar.
    // The sub-radio value IS the effective prefix (ammps:, ammps-lm:, ammps-rmmg:, etc.)
    document.querySelectorAll('input[name="ammps_scope"]').forEach(sub => {
      sub.addEventListener('change', function () {
        // Ensure the main searchEngine radio is set to ammps:
        const mainRadio = document.querySelector('input[name="searchEngine"][value="ammps:"]');
        if (mainRadio && !mainRadio.checked) {
          mainRadio.checked = true;
          document.querySelectorAll('input[name="searchEngine"]').forEach(r => r.parentElement.classList.remove('selected'));
          mainRadio.parentElement.classList.add('selected');
        }
        // Strip any existing ammps prefix from the input (keep the actual query)
        let val = searchInput.value.trim();
        let bestAmmpsKey = '';
        for (const key of AMMPS_PREFIXES) {
          if (val.startsWith(key) && key.length > bestAmmpsKey.length) bestAmmpsKey = key;
        }
        if (bestAmmpsKey) val = val.substring(bestAmmpsKey.length).trim();
        // Don't rewrite the input — the selected sub-radio drives the engine at submit time.
        // Just refresh the source bar.
        updateSearchSource();
      });
    });

    // ============================================
    // FORM SUBMIT
    // ============================================
    searchForm.addEventListener('submit', function (e) {
      e.preventDefault();
      let value = searchInput.value.trim();
      if (!value) return;

      // ── !bang inline engine routing ──────────────────────────────────────
      // detectBang() scans anywhere in the query for a known !bang token.
      // If matched: switch engine, strip the token, continue normal submit.
      // Unknown bangs (not in BANG_MAP) fall through to DuckDuckGo below.
      const bangResult = detectBang(value);
      if (bangResult && searchEngines[bangResult.prefix]) {
        const radio = document.querySelector(`input[name="searchEngine"][value="${bangResult.prefix}"]`);
        if (radio) {
          radio.checked = true;
          document.querySelectorAll('input[name="searchEngine"]').forEach(r => r.parentElement.classList.remove('selected'));
          radio.parentElement.classList.add('selected');
        }
        searchInput.value = bangResult.cleanQuery;
        bangIndicator.classList.remove('visible');
        // Re-form value as "prefix + cleanQuery" so the rest of the handler
        // treats this exactly like the user had typed the prefix manually.
        value = bangResult.prefix + bangResult.cleanQuery;
      }

      if (value.startsWith('!')) {
        window.open('https://duckduckgo.com/?q=' + encodeURIComponent(value), '_blank');
        return;
      }

      let prefix = '';
      let query  = '';

      // Longest-match: "cismef-bp: x" must match "cismef-bp:" not "cismef:"
      for (const key of Object.keys(searchEngines)) {
        if (value.startsWith(key) && key.length > prefix.length) { prefix = key; query = value.substring(key.length).trim(); }
      }

      if (!prefix) {
        const selected = document.querySelector('input[name="searchEngine"]:checked');
        if (selected) prefix = selected.value;
        query = value;
      }

      // site: override
      if (siteBtn.classList.contains('active')) {
        const selectedRadio = document.querySelector('input[name="searchEngine"]:checked');
        if (selectedRadio && searchEngines[selectedRadio.value]) {
          // msps: site: URL is already baked into .url — open it directly
          if (prefix === 'msps:') {
            const enc = encodeURIComponent(query);
            window.open(searchEngines['msps:'].url + enc, '_blank');
            return;
          }
          let siteUrl = searchEngines[selectedRadio.value].url;
          try { siteUrl = new URL(siteUrl).hostname; }
          catch { siteUrl = siteUrl.replace(/^https?:\/\//, '').split(/[/?#]/)[0]; }
          window.open('https://www.google.com/search?q=' + encodeURIComponent(`site:${siteUrl} ${query}`), '_blank');
          return;
        }
      }

      // msps: with site: OFF → use the direct site search URL
      if (prefix === 'msps:') {
        window.open(searchEngines['msps:'].directUrl + encodeURIComponent(query), '_blank');
        return;
      }

      // Resolve alias
      const engine = searchEngines[prefix];
      if (engine && engine.isAlias) {
        const filterRadio = document.querySelector(`input[name="cismef_scope"][value="${engine.filterValue}"]`);
        if (filterRadio) filterRadio.checked = true;
        prefix = engine.aliasFor;
      }

      if (!prefix || !query) return;

      // YouTube
      if (prefix === 'yt:') {
        let finalUrl = searchEngines['yt:'].url + encodeURIComponent(query);
        for (const groupName of ['yt_sort', 'yt_type', 'yt_duration', 'yt_date']) {
          const r = document.querySelector(`#youtubeFilters input[name="${groupName}"]:checked`);
          if (r && r.value) { finalUrl += '&sp=' + r.value; break; }
        }
        window.open(finalUrl, '_blank');
        return;
      }

      // CISMeF
      if (prefix === 'cismef:') {
        const r = document.querySelector('input[name="cismef_scope"]:checked');
        const params = r ? r.value : 'env=basic&q=';
        window.open(searchEngines['cismef:'].url + params + encodeURIComponent(query), '_blank');
        return;
      }

      // AMMPS — read sub-radio to pick the right engine
      if (AMMPS_PREFIXES.includes(prefix)) {
        let activePfx = prefix;
        // If "ammps:" → use whichever sub-radio is checked, default ammps:
        if (prefix === 'ammps:') {
          const sub = document.querySelector('input[name="ammps_scope"]:checked');
          activePfx  = sub ? sub.value : 'ammps:';
        }
        const eng = searchEngines[activePfx];
        if (!eng) return;
        const enc = encodeURIComponent(query).replace(/%20/g, '+');
        window.open(eng.url + enc, '_blank');
        return;
      }

      const finalEngine = searchEngines[prefix];
      if (!finalEngine) return;

      // Prompt-based engines
      if (finalEngine.promptBased) {
        navigator.clipboard.writeText(query).then(() => {
          createNotification('📋 Query copied — press Ctrl+V (⌘V) to paste it in the new tab.', 'success');
          window.open(finalEngine.url, '_blank');
        }).catch(() => {
          createNotification('Failed to copy query. Please copy it manually.', 'error');
          window.open(finalEngine.url, '_blank');
        });
        return;
      }

      let encodedQuery = finalEngine.plusEncoding
        ? encodeURIComponent(query).replace(/%20/g, '+')
        : encodeURIComponent(query);

      let finalUrl;
      if      (prefix === 'these-ma:') finalUrl = finalEngine.url + encodedQuery + '&submit=OK';
      else if (prefix === 'gpat:')     finalUrl = finalEngine.url + '?q=(' + encodedQuery + ')&oq=' + encodedQuery;
      else if (prefix === 'medscape:') finalUrl = finalEngine.url + '?q="' + encodedQuery + '"';
      else if (prefix === 'wiki:')     finalUrl = finalEngine.url + encodedQuery + '&title=Special%3ASearch&fulltext=1';
      else if (prefix === 'bdbk:')     finalUrl = finalEngine.url + encodeURIComponent(query) + '?fromModule=lemma_search-box';
      else                             finalUrl = finalEngine.url + encodedQuery;

      // Google Translate wrapper
      if (selectedOutputLang !== 'original') {
        window.open(`https://translate.google.com/translate?sl=auto&tl=${selectedOutputLang}&u=${encodeURIComponent(finalUrl)}`, '_blank');
        return;
      }

      window.open(finalUrl, '_blank');
    });

    // ============================================
    // WIKI TOGGLE
    // ============================================
    wikiToggleBtn.addEventListener('click', () => {
      if (wikiContent.style.display === 'block') {
        if (!keepWikiOpenCheckbox.checked) wikiContent.style.display = 'none';
      } else {
        wikiContent.style.display = 'block';
        wikiContent.focus();
        const wsi = document.getElementById('wikiSearchInput');
        if (wsi) setTimeout(() => wsi.focus(), 50);
      }
    });

    // ── Wiki filter logic ──────────────────────────────────────────────────
    (function initWikiFilters() {
      const wikiSearchInput  = document.getElementById('wikiSearchInput');
      const wikiSearchClear  = document.getElementById('wikiSearchClear');
      const wikiEmptyState   = document.getElementById('wikiEmptyState');
      const wikiEmptyQuery   = document.getElementById('wikiEmptyQuery');
      const catTabs          = document.querySelectorAll('.wiki-cat-tab');
      const sections         = document.querySelectorAll('.wiki-section');
      let activeCategory     = 'all';

      function applyFilters() {
        const q = wikiSearchInput.value.trim().toLowerCase();
        wikiSearchClear.style.display = q ? 'block' : 'none';
        let anyVisible = false;

        sections.forEach(section => {
          const sectionCat = section.dataset.section;
          const catOk = activeCategory === 'all' || activeCategory === sectionCat;
          if (!catOk) { section.classList.add('hidden'); return; }

          const chips = section.querySelectorAll('.wiki-chip');
          let sectionHasVisible = false;
          chips.forEach(chip => {
            const matches = !q || chip.dataset.prefix.toLowerCase().includes(q) || chip.dataset.name.toLowerCase().includes(q);
            chip.classList.toggle('chip-match-hidden', !matches);
            if (matches) sectionHasVisible = true;
          });

          section.classList.toggle('hidden', !sectionHasVisible);
          if (sectionHasVisible) anyVisible = true;
        });

        if (wikiEmptyState) {
          wikiEmptyState.style.display = anyVisible ? 'none' : 'block';
          if (wikiEmptyQuery) wikiEmptyQuery.textContent = wikiSearchInput.value.trim();
        }
      }

      wikiSearchInput.addEventListener('input', applyFilters);
      wikiSearchClear.addEventListener('click', () => {
        wikiSearchInput.value = '';
        wikiSearchInput.focus();
        applyFilters();
      });
      wikiSearchInput.addEventListener('keydown', e => { if (e.key === 'Enter') e.stopPropagation(); });

      catTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          catTabs.forEach(t => { t.classList.remove('active'); t.setAttribute('aria-selected', 'false'); });
          tab.classList.add('active');
          tab.setAttribute('aria-selected', 'true');
          activeCategory = tab.dataset.cat;
          applyFilters();
        });
      });

      document.querySelectorAll('.wiki-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          const prefix = chip.dataset.prefix;
          const radio  = document.querySelector(`input[name="searchEngine"][value="${prefix}"]`);
          if (radio) {
            radio.checked = true;
            document.querySelectorAll('input[name="searchEngine"]').forEach(r => r.parentElement.classList.remove('selected'));
            radio.parentElement.classList.add('selected');
            updateSearchSource();
          }
          chip.classList.add('chip-highlight');
          setTimeout(() => chip.classList.remove('chip-highlight'), 600);
          if (!keepWikiOpenCheckbox.checked) {
            setTimeout(() => { wikiContent.style.display = 'none'; }, 300);
          }
          searchInput.focus();
        });
      });
    })();

    // ============================================
    // BANG BUTTONS
    // ============================================
    bangsBtn.addEventListener('click', () => {
      const query = searchInput.value.trim();
      window.open('https://duckduckgo.com/bangs?q=' + encodeURIComponent(query), 'bangsWindow', 'width=800,height=600,scrollbars=yes,resizable=yes');
    });

    duckBangBtn.addEventListener('click', () => {
      window.open('https://mosermichael.github.io/duckduckbang/html/main.html', 'duckBangWindow', 'width=800,height=600,scrollbars=yes,resizable=yes');
    });

    // ============================================
    // FILETYPES POPUP
    // ============================================
    function updateFtCounter() {
      const count = document.querySelectorAll('.filetype-checkbox:checked').length;
      const el    = document.getElementById('ft-selected-count');
      if (el) el.textContent = count === 0 ? '0 selected' : `${count} selected`;
    }

    function renderFiletypesCheckboxes() {
      const grid = document.getElementById('filetype-grid');
      grid.innerHTML = '';
      const currentFiletypes = getCurrentlySelectedFiletypes();

      for (const [category, filetypes] of Object.entries(filetypesWiki)) {
        const categoryDiv      = document.createElement('div');
        categoryDiv.className  = 'filetype-category';
        const title            = document.createElement('h4');
        title.textContent      = category;
        categoryDiv.appendChild(title);

        const itemsContainer   = document.createElement('div');
        itemsContainer.className = 'filetype-items-container';

        filetypes.forEach(filetype => {
          const isArr     = Array.isArray(filetype.ext);
          const id        = `ft-checkbox-${isArr ? filetype.ext.join('-') : filetype.ext}`;
          const value     = isArr ? filetype.ext.join(',') : filetype.ext;
          const labelText = `${filetype.name} (.${isArr ? filetype.ext.join(', .') : filetype.ext})`;

          const itemDiv  = document.createElement('div');
          itemDiv.className = 'filetype-item';
          const label    = document.createElement('label');
          label.setAttribute('for', id);
          const checkbox = document.createElement('input');
          checkbox.type  = 'checkbox';
          checkbox.id    = id;
          checkbox.value = value;
          checkbox.className = 'filetype-checkbox';
          if (value.split(',').some(ext => currentFiletypes.includes(ext))) checkbox.checked = true;
          checkbox.addEventListener('change', updateFtCounter);
          label.appendChild(checkbox);
          label.append(` ${labelText}`);
          itemDiv.appendChild(label);
          itemsContainer.appendChild(itemDiv);
        });
        categoryDiv.appendChild(itemsContainer);
        grid.appendChild(categoryDiv);
      }
      updateFtCounter();
    }

    function getCurrentlySelectedFiletypes() {
      const regex = /filetype:([^\s()]+)/g;
      let matches;
      const extensions = [];
      while ((matches = regex.exec(searchInput.value)) !== null) extensions.push(matches[1]);
      return extensions;
    }

    function applyFiletypeFilter() {
      const checkedBoxes  = document.querySelectorAll('.filetype-checkbox:checked');
      const allExtensions = [];
      Array.from(checkedBoxes).forEach(cb => allExtensions.push(...cb.value.split(',')));

      let val = searchInput.value.trim().replace(/\s*\((filetype:[^)]+)\)\s*|\s*filetype:[^\s]+/g, '').trim();

      if (allExtensions.length > 0) {
        const filetypeQuery = allExtensions.map(ext => `filetype:${ext}`).join(' OR ');
        if (val.length > 0) val += ' ';
        val += allExtensions.length > 1 ? `(${filetypeQuery})` : filetypeQuery;
      }

      searchInput.value = val;
      updateSearchSource();
      closeFiletypesPopup();
      searchInput.focus();
    }

    function clearFiletypeSelection() {
      document.querySelectorAll('.filetype-checkbox').forEach(cb => cb.checked = false);
      updateFtCounter();
    }

    function openFiletypesPopup() {
      renderFiletypesCheckboxes();
      filetypesPopup.classList.add('show');
      popupOverlay.classList.add('show');
      document.getElementById('applyFiletypes').onclick = applyFiletypeFilter;
      document.getElementById('clearFiletypes').onclick = clearFiletypeSelection;
    }

    function closeFiletypesPopup() {
      filetypesPopup.classList.remove('show');
      popupOverlay.classList.remove('show');
    }

    // Google / Bing wiki popups
    function openGoogleWikiPopup()  { googleWikiPopup.classList.add('show'); popupOverlay.classList.add('show'); }
    function closeGoogleWikiPopup() {
      googleWikiPopup.classList.remove('show');
      if (!filetypesPopup.classList.contains('show')) popupOverlay.classList.remove('show');
    }
    function openBingWikiPopup()  { bingWikiPopup.classList.add('show'); popupOverlay.classList.add('show'); }
    function closeBingWikiPopup() {
      bingWikiPopup.classList.remove('show');
      if (!filetypesPopup.classList.contains('show') && !googleWikiPopup.classList.contains('show')) popupOverlay.classList.remove('show');
    }

    googleWikiBtn.addEventListener('click', openGoogleWikiPopup);
    closeGoogleWikiBtn.addEventListener('click', closeGoogleWikiPopup);
    bingWikiBtn.addEventListener('click', openBingWikiPopup);
    closeBingWikiBtn.addEventListener('click', closeBingWikiPopup);
    filetypesBtn.addEventListener('click', e => { e.stopPropagation(); openFiletypesPopup(); });
    closeFiletypes.addEventListener('click', closeFiletypesPopup);

    popupOverlay.addEventListener('click', () => {
      closeFiletypesPopup();
      if (keepGoogleWikiOpenCheckbox && !keepGoogleWikiOpenCheckbox.checked) closeGoogleWikiPopup();
      if (keepBingWikiOpenCheckbox   && !keepBingWikiOpenCheckbox.checked)   closeBingWikiPopup();
      closeShortcutsPopup();
    });

    document.addEventListener('click', e => {
      if (!wikiContent.contains(e.target) && e.target !== wikiToggleBtn) {
        if (wikiContent.style.display === 'block' && !keepWikiOpenCheckbox.checked) {
          wikiContent.style.display = 'none';
        }
      }
    });

    // ============================================
    // KEYBOARD SHORTCUTS
    // ============================================
    document.addEventListener('keydown', e => {
      if (e.ctrlKey && !e.shiftKey && e.key === 'k') {
        e.preventDefault();
        searchInput.focus();
      }
      if (e.ctrlKey && e.shiftKey && e.key === 'K') {
        e.preventDefault();
        searchInput.value = '';
        searchInput.focus();
      }
      if (e.altKey && (e.key === 'ArrowUp' || e.key === 'ArrowDown')) {
        e.preventDefault();
        const allRadios    = Array.from(document.querySelectorAll('input[name="searchEngine"]'));
        const currentRadio = document.querySelector('input[name="searchEngine"]:checked');
        let idx = allRadios.findIndex(r => r === currentRadio);
        idx = e.key === 'ArrowDown' ? (idx + 1) % allRadios.length : (idx - 1 + allRadios.length) % allRadios.length;
        allRadios[idx]?.click();
        searchInput.focus();
      }
      if (e.altKey && e.key >= '1' && e.key <= '4') {
        e.preventDefault();
        const groups    = ['#group1', '#group2', '#group3', '#group4'];
        const firstRadio = document.querySelector(`${groups[e.key - 1]} input`);
        if (firstRadio) firstRadio.click();
      }
      if (e.ctrlKey && e.shiftKey && e.key === 'C') {
        e.preventDefault();
        navigator.clipboard.writeText(searchInput.value).catch(() => {});
      }
      if (e.altKey && !e.shiftKey && e.key === 'g') {
        e.preventDefault();
        const selectedRadio = document.querySelector('input[name="searchEngine"]:checked');
        const query = searchInput.value.trim();
        if (selectedRadio && searchEngines[selectedRadio.value] && query) {
          let siteUrl = searchEngines[selectedRadio.value].url;
          try { siteUrl = new URL(siteUrl).hostname; }
          catch { siteUrl = siteUrl.replace(/^https?:\/\//, '').split(/[/?#]/)[0]; }
          window.open('https://www.google.com/search?q=' + encodeURIComponent(`site:${siteUrl} ${query}`), '_blank');
          siteBtn.classList.add('active');
          setTimeout(() => { if (siteBtn.getAttribute('aria-pressed') !== 'true') siteBtn.classList.remove('active'); }, 600);
        }
      }
      if (e.altKey && e.shiftKey && (e.key === 'G' || e.key === 'g')) {
        e.preventDefault();
        const isActive = siteBtn.classList.toggle('active');
        siteBtn.setAttribute('aria-pressed', isActive);
      }
      if (e.altKey && !e.shiftKey && e.key === 't') {
        e.preventDefault();
        langPopup.classList.contains('show') ? closeLangPopupFn() : openLangPopup();
      }
      // Alt+V — translate search bar (only for Yandex/Baidu engines)
      if (e.altKey && !e.shiftKey && (e.key === 'v' || e.key === 'V')) {
        if (getTranslateSearchTarget()) {
          e.preventDefault();
          translateSearchBar();
        }
      }
      if (e.altKey && e.shiftKey && (e.key === 'O' || e.key === 'o')) {
        e.preventDefault();
        updateLangIcon('original');
      }
      if (e.altKey && !e.shiftKey) {
        const langMap = { 'o': 'original', 'f': 'fr', 'e': 'en', 'a': 'ar', 's': 'es', 'r': 'ru', 'c': 'zh' };
        const skip    = new Set(['g', 't', 'k']);
        const key     = e.key.toLowerCase();
        if (langMap[key] && !skip.has(key)) { e.preventDefault(); updateLangIcon(langMap[key]); }
      }
      if (e.key === 'Escape') {
        if (filetypesPopup.classList.contains('show')) closeFiletypesPopup();
        if (googleWikiPopup.classList.contains('show') && !keepGoogleWikiOpenCheckbox.checked) closeGoogleWikiPopup();
        if (bingWikiPopup.classList.contains('show')   && !keepBingWikiOpenCheckbox.checked)   closeBingWikiPopup();
        if (wikiContent.style.display === 'block'      && !keepWikiOpenCheckbox.checked)        wikiContent.style.display = 'none';
        if (keyboardShortcutsPopup.classList.contains('show')) closeShortcutsPopup();
        if (langPopup.classList.contains('show')) closeLangPopupFn();
      }
    });

    // ============================================
    // INPUT LISTENER
    // ============================================
    searchInput.addEventListener('input', updateSearchSource);

    // ============================================
    // DARK MODE
    // ============================================
    const darkModeToggleBtn = document.getElementById('darkModeToggleBtn');
    darkModeToggleBtn.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode') ? 'enabled' : 'disabled');
    });
    if (localStorage.getItem('darkMode') === 'enabled') document.body.classList.add('dark-mode');

    // ============================================
    // OPERATOR TOOLTIP
    // ============================================
    const operatorTooltip = document.createElement('div');
    operatorTooltip.id        = 'operatorTooltip';
    operatorTooltip.className = 'operator-tooltip';
    document.body.appendChild(operatorTooltip);

    function buildOpTip(desc, example) {
      const exLine = example ? `<span class="op-tip-example">${example}</span>` : '';
      return `<span class="op-tip-desc">${desc}</span>${exLine}<div class="op-tip-footer"><img src="https://www.google.com/favicon.ico" alt="Google"></div>`;
    }

    const operatorDescriptions = {
      '" "':        buildOpTip('Search for an <strong>exact phrase</strong>', 'Example: "climate change"'),
      'OR':         buildOpTip('Results containing <strong>either</strong> term', 'Example: python OR java'),
      '-':          buildOpTip('<strong>Exclude</strong> results with this term', 'Example: apple -fruit'),
      '*':          buildOpTip('<strong>Wildcard</strong> — matches any word', 'Example: "best * for productivity"'),
      '( )':        buildOpTip('<strong>Group</strong> terms for complex queries', 'Example: (solar OR wind) energy'),
      'in':         buildOpTip('<strong>Convert</strong> units or currencies', 'Example: 100 km in miles'),
      'site:':      buildOpTip('Search inside a <strong>specific site</strong>', 'Example: site:nytimes.com'),
      'intitle:':   buildOpTip('Term must appear in the <strong>page title</strong>', 'Example: intitle:SEO'),
      'allintitle:':buildOpTip('<strong>All terms</strong> must be in the page title', 'Example: allintitle:SEO trends'),
      'inurl:':     buildOpTip('Term must appear in the <strong>page URL</strong>', 'Example: inurl:blog'),
      'allinurl:':  buildOpTip('<strong>All terms</strong> must be in the URL', 'Example: allinurl:blog seo'),
      'intext:':    buildOpTip('Term must appear in the <strong>body text</strong>', 'Example: intext:"quantum computing"'),
      'allintext:': buildOpTip('<strong>All terms</strong> must be in the body text', 'Example: allintext:AI ethics'),
      'filetype:':  buildOpTip('Restrict to a specific <strong>file type</strong>', 'Example: filetype:pdf'),
      'related:':   buildOpTip('Find sites <strong>similar</strong> to a domain', 'Example: related:mozilla.org'),
      'define:':    buildOpTip('Show the <strong>definition</strong> of a word', 'Example: define:serendipity'),
      'source:':    buildOpTip('In Google News, filter by <strong>outlet</strong>', 'Example: AI source:bbc'),
      'stocks:':    buildOpTip('Fetch <strong>stock information</strong>', 'Example: stocks:GOOGL'),
      'weather:':   buildOpTip('Show <strong>weather</strong> for a location', 'Example: weather:Tokyo'),
      'before:':    buildOpTip('Filter results <strong>before</strong> a date', 'Example: iPhone before:2023-01-01'),
      'after:':     buildOpTip('Filter results <strong>after</strong> a date', 'Example: iPhone after:2023-09-01'),
      'AROUND()':   buildOpTip('Terms within <strong>N words</strong> of each other', 'Example: "electric cars" AROUND(5) battery'),
    };

    const bingOperatorDescriptions = {
      '" "':       'Searches for an exact phrase match. Example: "search engine"',
      'OR':        'Returns results with either term. Example: bing OR google',
      'NOT':       'Excludes results with this term. Example: search NOT engine',
      'site:':     `<span style="display:flex;align-items:center;gap:6px;"><img src="https://www.google.com/favicon.ico" style="width:14px;height:14px;vertical-align:middle;"> Search inside this site with <strong>Google</strong></span>`,
      'filetype:': 'Restricts to a specific file type. Example: filetype:pdf',
      'inurl:':    'Finds the term in the page URL. Example: inurl:blog',
      'inbody:':   'Searches only in the body text. Example: inbody:"microservices"',
      'intitle:':  'Finds the term in the page title. Example: intitle:AI',
      'define:':   'Displays the definition of a word. Example: define:algorithm',
      'imagesize:':'Searches for images of a specific size.',
      'feed:':     'Returns RSS or Atom feeds.',
      'language:': 'Searches in a specific language. Example: language:fr'
    };

    let tooltipTimeout;

    function showTooltip(e, descriptions) {
      if (!e.target.classList.contains('operator-btn')) return;
      const description = descriptions[e.target.dataset.operator];
      if (!description) return;
      tooltipTimeout = setTimeout(() => {
        operatorTooltip.innerHTML = description;
        operatorTooltip.style.display = 'block';
        const rect        = e.target.getBoundingClientRect();
        const tipRect     = operatorTooltip.getBoundingClientRect();
        let top  = rect.top - tipRect.height - 5;
        if (top < 0) top = rect.bottom + 5;
        if (top + tipRect.height > window.innerHeight) top = rect.top - tipRect.height - 5;
        let left = rect.left + rect.width / 2 - tipRect.width / 2;
        if (left < 0) left = 5;
        if (left + tipRect.width > window.innerWidth) left = window.innerWidth - tipRect.width - 5;
        operatorTooltip.style.top  = `${top}px`;
        operatorTooltip.style.left = `${left}px`;
        setTimeout(() => { operatorTooltip.style.opacity = 1; }, 10);
      }, 300);
    }

    function hideTooltip(e) {
      if (!e.target.classList.contains('operator-btn')) return;
      clearTimeout(tooltipTimeout);
      operatorTooltip.style.opacity = 0;
      setTimeout(() => { if (operatorTooltip.style.opacity === '0') operatorTooltip.style.display = 'none'; }, 200);
    }

    googleOperatorFilters.addEventListener('mouseover', e => showTooltip(e, operatorDescriptions));
    googleOperatorFilters.addEventListener('mouseout',  hideTooltip);
    bingOperatorFilters.addEventListener('mouseover',   e => showTooltip(e, bingOperatorDescriptions));
    bingOperatorFilters.addEventListener('mouseout',    hideTooltip);

    function insertOperator(e) {
      if (!e.target.classList.contains('operator-btn')) return;
      const operator = e.target.dataset.operator;
      const input    = searchInput;
      if (input.value.trim() && !input.value.endsWith(' ')) input.value += ' ';
      let textToInsert = operator;
      let cursorOffset = 0;
      if (operator === '" "')   { textToInsert = '""';       cursorOffset = -1; }
      else if (operator === '( )')  { textToInsert = '()';       cursorOffset = -1; }
      else if (operator === 'AROUND()') { textToInsert = 'AROUND()'; cursorOffset = -1; }
      else if (operator === 'in')   { textToInsert = 'in '; }
      input.focus();
      const start = input.selectionStart;
      const end   = input.selectionEnd;
      input.value = input.value.substring(0, start) + textToInsert + input.value.substring(end);
      input.selectionStart = input.selectionEnd = start + textToInsert.length + cursorOffset;
    }

    googleOperatorFilters.addEventListener('click', insertOperator);
    bingOperatorFilters.addEventListener('click',   insertOperator);

    // site: button
    siteBtn.addEventListener('click', () => {
      const isActive = siteBtn.classList.toggle('active');
      siteBtn.setAttribute('aria-pressed', isActive);
    });

    siteBtn.addEventListener('mouseenter', () => {
      const activeName  = document.querySelector('input[name="searchEngine"]:checked')?.value || '';
      const engineName  = (activeName && searchEngines[activeName]?.name) || 'this engine';
      operatorTooltip.innerHTML = buildOpTip(`Search <strong>${engineName}</strong> using Google`, 'site:example.com');
      operatorTooltip.style.display = 'block';
      setTimeout(() => { operatorTooltip.style.opacity = 1; }, 10);
      const rect    = siteBtn.getBoundingClientRect();
      const tipRect = operatorTooltip.getBoundingClientRect();
      let top  = rect.top - tipRect.height - 8;
      if (top < 0) top = rect.bottom + 8;
      let left = rect.left + rect.width / 2 - tipRect.width / 2;
      if (left < 5) left = 5;
      if (left + tipRect.width > window.innerWidth) left = window.innerWidth - tipRect.width - 5;
      operatorTooltip.style.top  = `${top}px`;
      operatorTooltip.style.left = `${left}px`;
    });
    siteBtn.addEventListener('mouseleave', () => {
      operatorTooltip.style.opacity = 0;
      setTimeout(() => { if (operatorTooltip.style.opacity === '0') operatorTooltip.style.display = 'none'; }, 200);
    });

    // ============================================
    // NOTIFICATIONS
    // ============================================
    function createNotification(message, type = 'info') {
      const existing = document.querySelector('.notification');
      if (existing) document.body.removeChild(existing);
      const notification     = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      void notification.offsetWidth;
      notification.classList.add('show');
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => { if (document.body.contains(notification)) document.body.removeChild(notification); }, 300);
      }, 3000);
    }

    // ============================================
    // LANGUAGE TRANSLATION
    // ============================================
    const allLanguages = {
      ar:'Arabic', zh:'Chinese', en:'English', fr:'French', ru:'Russian', es:'Spanish',
      de:'German', ja:'Japanese', pt:'Portuguese', it:'Italian', ko:'Korean', nl:'Dutch',
      tr:'Turkish', pl:'Polish', sv:'Swedish', da:'Danish', fi:'Finnish', no:'Norwegian',
      cs:'Czech', hu:'Hungarian', ro:'Romanian', uk:'Ukrainian', el:'Greek', he:'Hebrew',
      th:'Thai', vi:'Vietnamese', id:'Indonesian', ms:'Malay', hi:'Hindi', bn:'Bengali',
      ur:'Urdu', fa:'Persian', sw:'Swahili', ta:'Tamil', te:'Telugu', mr:'Marathi',
      pa:'Punjabi', gu:'Gujarati', kn:'Kannada', ml:'Malayalam', si:'Sinhala', km:'Khmer',
      lo:'Lao', my:'Burmese', ka:'Georgian', am:'Amharic', ne:'Nepali', af:'Afrikaans',
      sq:'Albanian', hy:'Armenian', az:'Azerbaijani', eu:'Basque', be:'Belarusian',
      bs:'Bosnian', bg:'Bulgarian', ca:'Catalan', hr:'Croatian', et:'Estonian',
      tl:'Filipino', gl:'Galician', is:'Icelandic', ga:'Irish', lv:'Latvian',
      lt:'Lithuanian', mk:'Macedonian', mt:'Maltese', mn:'Mongolian', sr:'Serbian',
      sk:'Slovak', sl:'Slovenian', cy:'Welsh', yi:'Yiddish', zu:'Zulu', xh:'Xhosa',
      sn:'Shona', st:'Sesotho', yo:'Yoruba', ig:'Igbo', ha:'Hausa', ps:'Pashto',
      sd:'Sindhi', ug:'Uyghur', ku:'Kurdish', tg:'Tajik', uz:'Uzbek', kk:'Kazakh',
      ky:'Kyrgyz', tk:'Turkmen', mg:'Malagasy', ny:'Chichewa', so:'Somali',
      co:'Corsican', fy:'Frisian', gd:'Scottish Gaelic', haw:'Hawaiian', hmn:'Hmong',
      lb:'Luxembourgish', sm:'Samoan', ceb:'Cebuano', la:'Latin', eo:'Esperanto'
    };

    let selectedOutputLang = 'original';

    const langIcon        = document.getElementById('langIcon');
    const langPopup       = document.getElementById('langPopup');
    const closeLangPopup  = document.getElementById('closeLangPopup');
    const langButtons     = document.querySelectorAll('.lang-btn');
    const langSearchInput = document.getElementById('langSearchInput');
    const langSuggestions = document.getElementById('langSuggestions');

    function openLangPopup() {
      langPopup.classList.add('show');
      langSearchInput.focus();
    }

    function closeLangPopupFn() {
      langPopup.classList.remove('show');
      langSearchInput.value = '';
      langSuggestions.style.display = 'none';
      if (!filetypesPopup.classList.contains('show') &&
          !googleWikiPopup.classList.contains('show') &&
          !bingWikiPopup.classList.contains('show') &&
          !keyboardShortcutsPopup.classList.contains('show')) {
        popupOverlay.classList.remove('show');
      }
    }

    function updateLangIcon(langCode) {
      selectedOutputLang = langCode;
      if (langCode === 'original') {
        langIcon.textContent = '🌐';
        langIcon.classList.remove('language-selected');
        langIcon.title = 'Select output language';
      } else {
        langIcon.textContent = langCode.toUpperCase();
        langIcon.classList.add('language-selected');
        langIcon.title = `Translate to ${allLanguages[langCode] || langCode.toUpperCase()}`;
      }
      localStorage.setItem('selectedOutputLang', langCode);
    }

    langSearchInput.addEventListener('input', function () {
      const query = this.value.toLowerCase().trim();
      if (!query) { langSuggestions.style.display = 'none'; return; }
      const matches = Object.entries(allLanguages)
        .filter(([code, name]) => code.includes(query) || name.toLowerCase().includes(query))
        .slice(0, 10);
      if (matches.length) {
        langSuggestions.innerHTML = matches.map(([code, name]) =>
          `<div class="lang-suggestion" data-code="${code}"><strong>${name}</strong> <span>(${code})</span></div>`
        ).join('');
        langSuggestions.style.display = 'block';
        langSuggestions.querySelectorAll('.lang-suggestion').forEach(item => {
          item.addEventListener('click', () => { updateLangIcon(item.getAttribute('data-code')); closeLangPopupFn(); });
        });
      } else {
        langSuggestions.style.display = 'none';
      }
    });

    langIcon.addEventListener('click', e => { e.stopPropagation(); openLangPopup(); });
    closeLangPopup.addEventListener('click', closeLangPopupFn);
    langPopup.addEventListener('click', e => { if (e.target === langPopup) closeLangPopupFn(); });
    langButtons.forEach(btn => {
      btn.addEventListener('click', () => { updateLangIcon(btn.getAttribute('data-lang')); closeLangPopupFn(); });
    });

    // ============================================
    // AUTOCOMPLETE
    // ============================================
    const autocompleteDiv = document.createElement('div');
    autocompleteDiv.id    = 'autocomplete';
    searchInput.parentElement.appendChild(autocompleteDiv);

    let selectedIndex = -1;

    const engineCategories = {
      general:  ['g:', 'yt:', 'brave:', 'ddg:', 'yan:', 'bing:', 'bd:', 'gplus:', 'wiki:', 'bdbk:', 'grokw:', 'ww:'],
      academic: ['scholar:', 'pubmed:', 'arxiv:', 'gpat:', 'these2.0:', 'cismef-th:', 'these-ma:', 'these-fr:', 'rgate:', 'ndltd:', 'proinserm:', 'bdedu:'],
      medical:  ['cismef:', 'msps:', 'ammps:', 'ammps-lm:', 'ammps-rmmg:', 'ammps-lvl:', 'ammps-p:', 'ammps-gs:', 'has:', 'vidal:', 'mesh:', 'lissa:', 'anm:', 'hetop:', 'nejm:', 'rp:', 'utd:', 'coch:', 'medscape:', 'openmd:', 'dd:', 'webmd:', 'nih:', 'drugs:', 'cdc:', 'cismef-bp:', 'cismef-edu:', 'cismef-edn:', 'cismef-pat:'],
      ai:       ['wolf:', 'chatgpt:', 'claude:', 'gemini:', 'gai:', 'perplexity:', 'copilot:', 'cbd:', 'ernie:', 'duckai:']
    };

    const categoryTitles = {
      general:  '🌐 Recherche Générale',
      academic: '🎓 Académique / Thèses',
      medical:  '⚕️ Médical / Santé',
      ai:       '🤖 IA / Avancé'
    };

    function getCategoryForPrefix(prefix) {
      for (const [cat, prefixes] of Object.entries(engineCategories)) {
        if (prefixes.includes(prefix)) return cat;
      }
      return 'general';
    }

    function positionAutocomplete() {
      const inputRect       = searchInput.getBoundingClientRect();
      const containerRect   = document.querySelector('.search-container').getBoundingClientRect();
      const gap             = 10;
      const autocompleteH   = 400;
      const spaceBelow      = window.innerHeight - inputRect.bottom;
      const spaceAbove      = inputRect.top;
      const showAbove       = spaceAbove > autocompleteH + gap && spaceAbove > spaceBelow;

      if (showAbove) {
        autocompleteDiv.style.bottom = (window.innerHeight - inputRect.top + gap) + 'px';
        autocompleteDiv.style.top    = 'auto';
      } else {
        autocompleteDiv.style.top    = (inputRect.bottom + gap) + 'px';
        autocompleteDiv.style.bottom = 'auto';
      }

      const w = containerRect.width - 60;
      autocompleteDiv.style.width    = w + 'px';
      autocompleteDiv.style.maxWidth = w + 'px';
      autocompleteDiv.style.left     = (containerRect.left + 30) + 'px';
    }

    function showAutocomplete(matches) {
      if (matches.length === 0) { autocompleteDiv.style.display = 'none'; return; }
      selectedIndex = 0;

      const categorized = { general: [], academic: [], medical: [], ai: [] };
      matches.forEach(m => { categorized[getCategoryForPrefix(m.prefix)].push(m); });

      autocompleteDiv.innerHTML = '<div class="autocomplete-grid"></div>';
      const grid = autocompleteDiv.querySelector('.autocomplete-grid');
      let globalIdx = 0;

      ['general', 'academic', 'medical', 'ai'].forEach(cat => {
        const col = document.createElement('div');
        col.className = 'autocomplete-column';
        if (categorized[cat].length > 0) {
          const title = document.createElement('div');
          title.className   = 'autocomplete-column-title';
          title.textContent = categoryTitles[cat];
          col.appendChild(title);

          categorized[cat].forEach(match => {
            const flatIdx = globalIdx++;
            const item    = document.createElement('div');
            item.className = 'autocomplete-item';
            if (flatIdx === selectedIndex) item.classList.add('selected');

            const faviconUrl = match.engine.favicon || (match.engine.domain ? `https://www.google.com/s2/favicons?sz=32&domain=${match.engine.domain}` : null);
            if (faviconUrl) {
              const fav = document.createElement('img');
              fav.src = faviconUrl; fav.alt = ''; fav.className = 'favicon-icon';
              item.appendChild(fav);
            }

            const pfx = document.createElement('span');
            pfx.className   = 'autocomplete-prefix';
            pfx.textContent = match.prefix;
            item.appendChild(pfx);

            const nm = document.createElement('span');
            nm.className   = 'autocomplete-name';
            nm.textContent = match.engine.name;
            item.appendChild(nm);

            item.addEventListener('click', () => {
              const pfxKey = match.prefix;
              // Resolve parent engine key for aliases / AMMPS sub-prefixes
              const parentKey = searchEngines[pfxKey]?.isAlias ? searchEngines[pfxKey].aliasFor
                : AMMPS_PREFIXES.includes(pfxKey) && pfxKey !== 'ammps:' ? 'ammps:' : pfxKey;
              const targetRadio = document.querySelector(`input[name="searchEngine"][value="${parentKey}"]`)
                || document.querySelector(`input[name="searchEngine"][value="${pfxKey}"]`);
              if (targetRadio) {
                targetRadio.checked = true;
                document.querySelectorAll('input[name="searchEngine"]').forEach(r => r.parentElement.classList.remove('selected'));
                targetRadio.parentElement.classList.add('selected');
              }
              // Sync sub-radios before stripping
              if (searchEngines[pfxKey]?.isAlias && searchEngines[pfxKey].filterValue) {
                const subRadio = document.querySelector(`input[name="cismef_scope"][value="${searchEngines[pfxKey].filterValue}"]`);
                if (subRadio) subRadio.checked = true;
              }
              if (AMMPS_PREFIXES.includes(pfxKey) && pfxKey !== 'ammps:') {
                const subRadio = document.querySelector(`input[name="ammps_scope"][value="${pfxKey}"]`);
                if (subRadio) subRadio.checked = true;
              }
              let val = searchInput.value.trim();
              // Strip a fully-typed prefix (e.g. "brave: something" → "something") — longest match wins
              let stripped = false;
              let bestStripKey = '';
              for (const key of Object.keys(searchEngines)) {
                if (val.toLowerCase().startsWith(key.toLowerCase()) && key.length > bestStripKey.length) {
                  bestStripKey = key;
                  stripped = true;
                }
              }
              if (stripped) val = val.substring(bestStripKey.length).trim();
              // If no full prefix matched, the user typed a partial prefix (e.g. "brav")
              // to navigate the autocomplete — clear it entirely, it's not a real query.
              if (!stripped) val = '';
              searchInput.value = val;
              autocompleteDiv.style.display = 'none';
              updateSearchSource();
              searchInput.focus();
            });

            col.appendChild(item);
          });
        }
        grid.appendChild(col);
      });

      autocompleteDiv.style.display = 'block';
      positionAutocomplete();
      autocompleteDiv.querySelector('.autocomplete-item.selected')?.scrollIntoView({ block: 'nearest' });
    }

    searchInput.addEventListener('input', function (e) {
      const value      = e.target.value;
      const valueLower = value.trim().toLowerCase();
      selectedIndex    = -1;

      // Live !bang detection → show/hide indicator pill
      const bangHit = detectBang(value);
      if (bangHit && searchEngines[bangHit.prefix]) {
        const engineName = searchEngines[bangHit.prefix].name.replace(/\s*📋$/, '');
        bangEngineLabel.textContent = engineName;
        bangIndicator.classList.add('visible');
      } else {
        bangIndicator.classList.remove('visible');
      }

      // Exact prefix detection → strip prefix, select engine (longest match wins)
      let exactKey = '';
      for (const key of Object.keys(searchEngines)) {
        if (valueLower.startsWith(key.toLowerCase()) && key.length > exactKey.length) exactKey = key;
      }
      if (exactKey) {
        const key = exactKey;
        const radio = document.querySelector(`input[name="searchEngine"][value="${key}"]`);
        // For sub-prefixes (cismef-bp:, ammps-lvl: etc.) select their parent radio
        const parentKey = searchEngines[key]?.isAlias ? searchEngines[key].aliasFor
          : AMMPS_PREFIXES.includes(key) && key !== 'ammps:' ? 'ammps:' : key;
        const targetRadio = document.querySelector(`input[name="searchEngine"][value="${parentKey}"]`) || radio;
        if (targetRadio) {
          targetRadio.checked = true;
          document.querySelectorAll('input[name="searchEngine"]').forEach(r => r.parentElement.classList.remove('selected'));
          targetRadio.parentElement.classList.add('selected');
        }
        // Sync sub-radios NOW — before the prefix is stripped from the input.
        // After stripping, updateSearchSource can't tell which alias was typed.
        if (searchEngines[key]?.isAlias && searchEngines[key].filterValue) {
          // CISMeF alias (cismef-bp:, cismef-edu:, etc.) → check its scope radio
          const subRadio = document.querySelector(`input[name="cismef_scope"][value="${searchEngines[key].filterValue}"]`);
          if (subRadio) subRadio.checked = true;
        }
        if (AMMPS_PREFIXES.includes(key) && key !== 'ammps:') {
          // AMMPS sub-prefix (ammps-lvl:, ammps-lm:, etc.) → check its scope radio
          const subRadio = document.querySelector(`input[name="ammps_scope"][value="${key}"]`);
          if (subRadio) subRadio.checked = true;
        }
        searchInput.value = value.trim().substring(key.length).trim();
        autocompleteDiv.style.display = 'none';
        bangIndicator.classList.remove('visible');
        updateSearchSource();
        return;
      }

      if (!valueLower || valueLower.includes(' ')) {
        autocompleteDiv.style.display = 'none';
        updateSearchSource();
        return;
      }

      const matches = Object.keys(searchEngines)
        .filter(prefix => {
          const eng = searchEngines[prefix];
          return prefix.toLowerCase().startsWith(valueLower) || eng.name.toLowerCase().includes(valueLower);
        })
        .map(prefix => ({ prefix, engine: searchEngines[prefix] }));

      showAutocomplete(matches);
      updateSearchSource();
    });

    searchInput.addEventListener('keydown', function (e) {
      const items = autocompleteDiv.querySelectorAll('.autocomplete-item');
      if (autocompleteDiv.style.display === 'none' || items.length === 0) return;
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
        items.forEach((item, i) => item.classList.toggle('selected', i === selectedIndex));
        items[selectedIndex]?.scrollIntoView({ block: 'nearest' });
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedIndex = Math.max(selectedIndex - 1, 0);
        items.forEach((item, i) => item.classList.toggle('selected', i === selectedIndex));
        items[selectedIndex]?.scrollIntoView({ block: 'nearest' });
      } else if (e.key === 'Enter' && selectedIndex >= 0) {
        e.preventDefault();
        items[selectedIndex]?.click();
      } else if (e.key === 'Escape') {
        autocompleteDiv.style.display = 'none';
      }
    });

    document.addEventListener('click', e => {
      if (!searchInput.contains(e.target) && !autocompleteDiv.contains(e.target)) {
        autocompleteDiv.style.display = 'none';
      }
    });

    window.addEventListener('resize', () => { if (autocompleteDiv.style.display === 'block') positionAutocomplete(); });
    window.addEventListener('scroll', () => { if (autocompleteDiv.style.display === 'block') positionAutocomplete(); });

    // ============================================
    // FOCUS OVERLAY
    // ============================================
    const focusOverlay    = document.getElementById('focusOverlay');
    const searchContainer = document.querySelector('.search-container');

    searchInput.addEventListener('focus', () => {
      focusOverlay.classList.add('active');
      searchContainer.classList.add('focused');
    });
    searchInput.addEventListener('blur', () => {
      setTimeout(() => {
        focusOverlay.classList.remove('active');
        searchContainer.classList.remove('focused');
      }, 200);
    });
    focusOverlay.addEventListener('click', () => {
      searchInput.blur();
      autocompleteDiv.style.display = 'none';
    });

    // ============================================
    // INIT
    // ============================================
    window.addEventListener('load', () => {
      updateSearchSource();
      searchInput.focus();
      addFaviconsToSearchEngines();
      const savedLang = localStorage.getItem('selectedOutputLang');
      if (savedLang) updateLangIcon(savedLang);
    });
  </script>
  <div id="paste-legend">
    📋 &nbsp;Engines marked with <strong style="color:#e0e0e0">📋</strong> can't receive queries via URL — your query is auto-copied to the clipboard when you search. Just press <kbd>Ctrl</kbd>+<kbd>V</kbd> (or <kbd>⌘</kbd>+<kbd>V</kbd> on Mac) once the page opens.
  </div>

</body>
</html>
